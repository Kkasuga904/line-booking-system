<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²é£Ÿåº— å¸­ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .stat-card .label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-card .sub {
            color: #999;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* å¸­ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .floor-layout {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .floor-layout h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* å¸­ã®é…ç½® */
        .seat-areas {
            display: grid;
            gap: 30px;
        }
        
        .seat-section {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            background: #fafafa;
        }
        
        .seat-section h3 {
            color: #555;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .seats-grid {
            display: grid;
            gap: 10px;
        }
        
        .counter-seats {
            grid-template-columns: repeat(8, 1fr);
        }
        
        .table-seats {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .private-seats {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .seat {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .seat.available {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .seat.occupied {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .seat.reserved {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .seat.cleaning {
            background: #d1ecf1;
            border-color: #17a2b8;
        }
        
        .seat:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .seat-id {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .seat-capacity {
            font-size: 12px;
            color: #666;
        }
        
        .seat-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        /* äºˆç´„ãƒªã‚¹ãƒˆ */
        .reservations-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .reservations-panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .reservation-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab.active {
            color: #FF6B6B;
            border-bottom-color: #FF6B6B;
            font-weight: 600;
        }
        
        .reservation-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .reservation-item {
            border-left: 4px solid #FF6B6B;
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s;
        }
        
        .reservation-item:hover {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .reservation-time {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        
        .reservation-seat {
            background: #FF6B6B;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .reservation-details {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .actions-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .current-time {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-weight: 600;
            color: #333;
        }
        
        @media (max-width: 768px) {
            .counter-seats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .table-seats,
            .private-seats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ğŸ½ï¸ ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å¸­ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="subtitle">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç©ºå¸­çŠ¶æ³ãƒ»äºˆç´„ç®¡ç†</div>
        </div>
    </div>
    
    <div class="current-time" id="currentTime"></div>
    
    <div class="container">
        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="label">ç©ºå¸­æ•°</div>
                <div class="value" id="availableSeats">12</div>
                <div class="sub">/ å…¨16å¸­</div>
            </div>
            <div class="stat-card">
                <div class="label">ä½¿ç”¨ä¸­</div>
                <div class="value" id="occupiedSeats">3</div>
                <div class="sub">18:30ã‹ã‚‰</div>
            </div>
            <div class="stat-card">
                <div class="label">äºˆç´„æ¸ˆ</div>
                <div class="value" id="reservedSeats">1</div>
                <div class="sub">19:00ï½</div>
            </div>
            <div class="stat-card">
                <div class="label">æœ¬æ—¥ã®äºˆç´„</div>
                <div class="value" id="todayReservations">8</div>
                <div class="sub">çµ„</div>
            </div>
            <div class="stat-card">
                <div class="label">å›è»¢ç‡</div>
                <div class="value">2.3</div>
                <div class="sub">å›/æ—¥</div>
            </div>
        </div>
        
        <!-- å¸­ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
        <div class="floor-layout">
            <h2>ğŸ—ºï¸ ãƒ•ãƒ­ã‚¢ãƒãƒƒãƒ—</h2>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #d4edda;"></div>
                    <span>ç©ºå¸­</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f8d7da;"></div>
                    <span>ä½¿ç”¨ä¸­</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff3cd;"></div>
                    <span>äºˆç´„æ¸ˆ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d1ecf1;"></div>
                    <span>æ¸…æƒä¸­</span>
                </div>
            </div>
            
            <div class="seat-areas">
                <!-- ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­ -->
                <div class="seat-section">
                    <h3>ğŸª‘ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­</h3>
                    <div class="seats-grid counter-seats" id="counterSeats">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- ãƒ†ãƒ¼ãƒ–ãƒ«å¸­ -->
                <div class="seat-section">
                    <h3>ğŸª‘ğŸª‘ ãƒ†ãƒ¼ãƒ–ãƒ«å¸­</h3>
                    <div class="seats-grid table-seats" id="tableSeats">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- å€‹å®¤ -->
                <div class="seat-section">
                    <h3>ğŸšª å€‹å®¤</h3>
                    <div class="seats-grid private-seats" id="privateSeats">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <div class="actions-row">
                <button class="btn btn-primary" onclick="refreshSeats()">ğŸ”„ æ›´æ–°</button>
                <button class="btn btn-success" onclick="showReservationModal()">â• æ–°è¦äºˆç´„</button>
                <button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button>
                <button class="btn btn-warning" onclick="clearAll()">ğŸ§¹ å…¨å¸­ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="btn btn-primary" onclick="window.open('/admin-send.html', '_blank')">ğŸ“© ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</button>
                <button class="btn btn-secondary" onclick="window.location.href='/seat-config.html'">âš™ï¸ å¸­é…ç½®è¨­å®š</button>
            </div>
        </div>
        
        <!-- äºˆç´„ãƒªã‚¹ãƒˆ -->
        <div class="reservations-panel">
            <h2>ğŸ“‹ äºˆç´„ç®¡ç†</h2>
            
            <div class="reservation-tabs">
                <button class="tab active" onclick="switchTab('waiting')">å¾…ã¡ (3)</button>
                <button class="tab" onclick="switchTab('today')">æœ¬æ—¥ (8)</button>
                <button class="tab" onclick="switchTab('tomorrow')">æ˜æ—¥ (5)</button>
            </div>
            
            <div class="reservation-list" id="reservationList">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- å¸­è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="seatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">å¸­ã®è©³ç´°</h2>
            </div>
            <div class="form-group">
                <label>å¸­ç•ªå·</label>
                <input type="text" id="modalSeatId" readonly>
            </div>
            <div class="form-group">
                <label>çŠ¶æ…‹</label>
                <select id="modalStatus">
                    <option value="available">ç©ºå¸­</option>
                    <option value="occupied">ä½¿ç”¨ä¸­</option>
                    <option value="reserved">äºˆç´„æ¸ˆ</option>
                    <option value="cleaning">æ¸…æƒä¸­</option>
                </select>
            </div>
            <div class="form-group">
                <label>ãŠå®¢æ§˜å</label>
                <input type="text" id="modalCustomer" placeholder="å±±ç”°å¤ªéƒ">
            </div>
            <div class="form-group">
                <label>äººæ•°</label>
                <input type="number" id="modalPeople" min="1" max="10" value="2">
            </div>
            <div class="form-group">
                <label>æ™‚é–“</label>
                <input type="time" id="modalTime">
            </div>
            <div class="form-group">
                <label>å¸­ã‚’ç§»å‹•</label>
                <select id="modalMoveSeat">
                    <option value="">å¸­ã‚’ç§»å‹•ã—ãªã„</option>
                </select>
            </div>
            <div class="actions-row">
                <button class="btn btn-primary" onclick="saveSeat()">ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <script>
        // å¸­ãƒ‡ãƒ¼ã‚¿
        const seatData = {
            counter: [
                { id: 'C1', capacity: 1, status: 'available' },
                { id: 'C2', capacity: 1, status: 'available' },
                { id: 'C3', capacity: 1, status: 'occupied', customer: 'ç”°ä¸­æ§˜', time: '18:30' },
                { id: 'C4', capacity: 1, status: 'available' },
                { id: 'C5', capacity: 1, status: 'available' },
                { id: 'C6', capacity: 1, status: 'available' },
                { id: 'C7', capacity: 1, status: 'occupied', customer: 'ä½è—¤æ§˜', time: '19:00' },
                { id: 'C8', capacity: 1, status: 'available' }
            ],
            table: [
                { id: 'T1', capacity: 4, status: 'available' },
                { id: 'T2', capacity: 4, status: 'available' },
                { id: 'T3', capacity: 4, status: 'occupied', customer: 'éˆ´æœ¨æ§˜(3å)', time: '18:00' },
                { id: 'T4', capacity: 4, status: 'available' },
                { id: 'T5', capacity: 4, status: 'reserved', customer: 'é«˜æ©‹æ§˜(4å)', time: '19:30' }
            ],
            private: [
                { id: 'P1', capacity: 6, status: 'available' },
                { id: 'P2', capacity: 8, status: 'cleaning' },
                { id: 'P3', capacity: 6, status: 'available' }
            ]
        };
        
        // äºˆç´„ãƒ‡ãƒ¼ã‚¿ï¼ˆAPIã‹ã‚‰å–å¾—ï¼‰
        let reservations = [];
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadSeatLayout();
            loadReservations();
            renderSeats();
            updateStats();
            updateTime();
            setInterval(updateTime, 1000);
            // 30ç§’ã”ã¨ã«äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•æ›´æ–°
            setInterval(loadReservations, 30000);
        });
        
        // å¸­é…ç½®ã‚’èª­ã¿è¾¼ã¿
        async function loadSeatLayout() {
            try {
                // LocalStorageã‹ã‚‰å–å¾—ï¼ˆå„ªå…ˆï¼‰
                const savedLayouts = localStorage.getItem('seatLayouts');
                if (savedLayouts) {
                    const layouts = JSON.parse(savedLayouts);
                    const storeId = localStorage.getItem('currentStoreId') || 'default';
                    
                    if (layouts[storeId]) {
                        seatData.counter = layouts[storeId].counter.map(s => ({
                            ...s,
                            status: 'available'
                        }));
                        seatData.table = layouts[storeId].table.map(s => ({
                            ...s,
                            status: 'available'
                        }));
                        seatData.private = layouts[storeId].private.map(s => ({
                            ...s,
                            status: 'available'
                        }));
                        
                        console.log('å¸­é…ç½®ã‚’LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', storeId);
                        return;
                    }
                }
                
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
                const response = await fetch('/api/seat-layout?storeId=default');
                const data = await response.json();
                
                if (data.layout) {
                    seatData.counter = data.layout.counter.map(s => ({
                        ...s,
                        status: 'available'
                    }));
                    seatData.table = data.layout.table.map(s => ({
                        ...s,
                        status: 'available'
                    }));
                    seatData.private = data.layout.private.map(s => ({
                        ...s,
                        status: 'available'
                    }));
                    
                    console.log('å¸­é…ç½®ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                }
            } catch (err) {
                console.log('ã‚«ã‚¹ã‚¿ãƒ å¸­é…ç½®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™');
            }
        }
        
        // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’APIã‹ã‚‰å–å¾—
        async function loadReservations() {
            try {
                const response = await fetch('/api/reservations');
                const data = await response.json();
                reservations = data.reservations || [];
                
                // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¸­ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateSeatStatusFromReservations();
                renderReservations();
                updateStats();
            } catch (err) {
                console.error('äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
            }
        }
        
        // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¸­ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateSeatStatusFromReservations() {
            // å…¨å¸­ã‚’ä¸€æ—¦åˆ©ç”¨å¯èƒ½ã«ãƒªã‚»ãƒƒãƒˆ
            Object.values(seatData).forEach(section => {
                section.forEach(seat => {
                    if (seat.status !== 'cleaning') {
                        seat.status = 'available';
                        delete seat.customer;
                        delete seat.time;
                    }
                });
            });
            
            // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ 
            const now = new Date();
            reservations.forEach(reservation => {
                if (reservation.status === 'cancelled') return;
                
                const reservationTime = new Date(reservation.dateTime || reservation.createdAt);
                const timeDiff = (reservationTime - now) / (1000 * 60); // åˆ†å˜ä½
                
                // ç¾åœ¨æ™‚åˆ»ã®å‰å¾Œ2æ™‚é–“ä»¥å†…ã®äºˆç´„ã‚’è¡¨ç¤º
                if (Math.abs(timeDiff) < 120) {
                    const seatId = reservation.seatId || assignSeat(reservation);
                    const seat = findSeat(seatId);
                    
                    if (seat) {
                        if (timeDiff < -30) {
                            // 30åˆ†ä»¥ä¸Šå‰ã®äºˆç´„ã¯ä½¿ç”¨ä¸­
                            seat.status = 'occupied';
                        } else if (timeDiff < 30) {
                            // 30åˆ†ä»¥å†…ã®äºˆç´„ã¯äºˆç´„æ¸ˆã¿
                            seat.status = 'reserved';
                        }
                        
                        seat.customer = `${reservation.customerName}(${reservation.people || 1}å)`;
                        seat.time = formatTime(reservationTime);
                    }
                }
            });
            
            renderSeats();
        }
        
        // å¸­ã‚’æ¢ã™
        function findSeat(seatId) {
            for (const section of Object.values(seatData)) {
                const seat = section.find(s => s.id === seatId);
                if (seat) return seat;
            }
            return null;
        }
        
        // è‡ªå‹•çš„ã«å¸­ã‚’å‰²ã‚Šå½“ã¦
        function assignSeat(reservation) {
            const people = reservation.people || 1;
            
            // äººæ•°ã«å¿œã˜ã¦é©åˆ‡ãªå¸­ã‚’æ¢ã™
            if (people <= 1) {
                // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­å„ªå…ˆ
                const available = seatData.counter.find(s => s.status === 'available');
                if (available) {
                    reservation.seatId = available.id;
                    return available.id;
                }
            } else if (people <= 4) {
                // ãƒ†ãƒ¼ãƒ–ãƒ«å¸­
                const available = seatData.table.find(s => s.status === 'available');
                if (available) {
                    reservation.seatId = available.id;
                    return available.id;
                }
            } else {
                // å€‹å®¤
                const available = seatData.private.find(s => s.status === 'available');
                if (available) {
                    reservation.seatId = available.id;
                    return available.id;
                }
            }
            
            // ç©ºå¸­ãŒãªã„å ´åˆã¯ä»®ã®å¸­ç•ªå·
            return 'W' + people; // Waiting
        }
        
        // æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTime(date) {
            const d = new Date(date);
            return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // å¸­ã®æç”»
        function renderSeats() {
            // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­
            const counterContainer = document.getElementById('counterSeats');
            counterContainer.innerHTML = seatData.counter.map(seat => 
                createSeatElement(seat)
            ).join('');
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«å¸­
            const tableContainer = document.getElementById('tableSeats');
            tableContainer.innerHTML = seatData.table.map(seat => 
                createSeatElement(seat)
            ).join('');
            
            // å€‹å®¤
            const privateContainer = document.getElementById('privateSeats');
            privateContainer.innerHTML = seatData.private.map(seat => 
                createSeatElement(seat)
            ).join('');
        }
        
        // å¸­è¦ç´ ã®ä½œæˆ
        function createSeatElement(seat) {
            return `
                <div class="seat ${seat.status}" onclick="showSeatDetails('${seat.id}')">
                    <div class="seat-id">${seat.id}</div>
                    <div class="seat-capacity">${seat.capacity}åå¸­</div>
                    ${seat.customer ? `<div class="seat-time">${seat.customer}</div>` : ''}
                    ${seat.time ? `<div class="seat-time">${seat.time}ï½</div>` : ''}
                </div>
            `;
        }
        
        // äºˆç´„ãƒªã‚¹ãƒˆã®æç”»
        function renderReservations() {
            const container = document.getElementById('reservationList');
            
            // ä»Šæ—¥ã®äºˆç´„ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const today = new Date();
            const todayReservations = reservations.filter(r => {
                const rDate = new Date(r.dateTime || r.createdAt);
                return rDate.toDateString() === today.toDateString() && r.status !== 'cancelled';
            });
            
            // æ™‚é–“ã§ã‚½ãƒ¼ãƒˆ
            todayReservations.sort((a, b) => {
                const aTime = new Date(a.dateTime || a.createdAt);
                const bTime = new Date(b.dateTime || b.createdAt);
                return aTime - bTime;
            });
            
            container.innerHTML = todayReservations.map(reservation => {
                const time = formatTime(new Date(reservation.dateTime || reservation.createdAt));
                const seatId = reservation.seatId || 'W';
                
                return `
                    <div class="reservation-item" data-reservation-id="${reservation.id}">
                        <div class="reservation-header">
                            <div class="reservation-time">${time}</div>
                            <div class="reservation-seat" style="cursor: pointer;" onclick="showSeatAssignModal('${reservation.id}')">${seatId} âœï¸</div>
                        </div>
                        <div class="reservation-details">
                            ğŸ‘¤ ${reservation.customerName || 'åå‰ãªã—'} (${reservation.people || 1}å)<br>
                            ğŸ“± ${reservation.phone || 'LINEäºˆç´„'}<br>
                            ğŸ’¬ ${reservation.notes || 'ç‰¹è¨˜äº‹é …ãªã—'}
                        </div>
                    </div>
                `;
            }).join('') || '<p style="text-align: center; color: #999;">æœ¬æ—¥ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            let available = 0, occupied = 0, reserved = 0;
            
            Object.values(seatData).forEach(section => {
                section.forEach(seat => {
                    if (seat.status === 'available') available++;
                    else if (seat.status === 'occupied') occupied++;
                    else if (seat.status === 'reserved') reserved++;
                });
            });
            
            document.getElementById('availableSeats').textContent = available;
            document.getElementById('occupiedSeats').textContent = occupied;
            document.getElementById('reservedSeats').textContent = reserved;
        }
        
        // å¸­è©³ç´°è¡¨ç¤º
        function showSeatDetails(seatId) {
            const modal = document.getElementById('seatModal');
            const seat = findSeat(seatId);
            
            document.getElementById('modalSeatId').value = seatId;
            
            // ç¾åœ¨ã®å¸­ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
            if (seat) {
                document.getElementById('modalStatus').value = seat.status;
                
                // äºˆç´„æƒ…å ±ãŒã‚ã‚‹å ´åˆ
                const reservation = findReservationBySeat(seatId);
                if (reservation) {
                    document.getElementById('modalCustomer').value = reservation.customerName || '';
                    document.getElementById('modalPeople').value = reservation.people || 1;
                    document.getElementById('modalTime').value = formatTimeForInput(new Date(reservation.dateTime || reservation.createdAt));
                    
                    // äºˆç´„IDã‚’ä¿å­˜ï¼ˆå¸­ç§»å‹•ç”¨ï¼‰
                    modal.dataset.reservationId = reservation.id;
                } else {
                    document.getElementById('modalCustomer').value = '';
                    document.getElementById('modalPeople').value = 2;
                    document.getElementById('modalTime').value = '';
                    delete modal.dataset.reservationId;
                }
            }
            
            // å¸­ç§»å‹•ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            updateSeatMoveOptions(seatId);
            
            modal.classList.add('show');
        }
        
        // äºˆç´„ã‚’å¸­ã§æ¤œç´¢
        function findReservationBySeat(seatId) {
            return reservations.find(r => r.seatId === seatId && r.status !== 'cancelled');
        }
        
        // æ™‚åˆ»ã‚’å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
        function formatTimeForInput(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // å¸­ç§»å‹•ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateSeatMoveOptions(currentSeatId) {
            const moveSelect = document.getElementById('modalMoveSeat');
            if (!moveSelect) return;
            
            moveSelect.innerHTML = '<option value="">å¸­ã‚’ç§»å‹•ã—ãªã„</option>';
            
            // ç©ºã„ã¦ã„ã‚‹å¸­ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
            Object.entries(seatData).forEach(([section, seats]) => {
                const sectionName = section === 'counter' ? 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼' : 
                                   section === 'table' ? 'ãƒ†ãƒ¼ãƒ–ãƒ«' : 'å€‹å®¤';
                
                seats.forEach(seat => {
                    if (seat.id !== currentSeatId && seat.status === 'available') {
                        const option = document.createElement('option');
                        option.value = seat.id;
                        option.textContent = `${sectionName} - ${seat.id} (${seat.capacity}åå¸­)`;
                        moveSelect.appendChild(option);
                    }
                });
            });
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('seatModal').classList.remove('show');
        }
        
        // å¸­æƒ…å ±ä¿å­˜
        async function saveSeat() {
            const modal = document.getElementById('seatModal');
            const currentSeatId = document.getElementById('modalSeatId').value;
            const newSeatId = document.getElementById('modalMoveSeat').value;
            const status = document.getElementById('modalStatus').value;
            const customerName = document.getElementById('modalCustomer').value;
            const people = document.getElementById('modalPeople').value;
            const time = document.getElementById('modalTime').value;
            
            // äºˆç´„IDãŒã‚ã‚‹å ´åˆï¼ˆæ—¢å­˜ã®äºˆç´„ï¼‰
            const reservationId = modal.dataset.reservationId;
            
            if (reservationId) {
                // äºˆç´„ã‚’æ›´æ–°
                const reservation = reservations.find(r => r.id === reservationId);
                if (reservation) {
                    // å¸­ã‚’ç§»å‹•ã™ã‚‹å ´åˆ
                    if (newSeatId) {
                        reservation.seatId = newSeatId;
                        
                        // å…ƒã®å¸­ã‚’ç©ºå¸­ã«
                        const oldSeat = findSeat(currentSeatId);
                        if (oldSeat) {
                            oldSeat.status = 'available';
                            delete oldSeat.customer;
                            delete oldSeat.time;
                        }
                        
                        // æ–°ã—ã„å¸­ã«äºˆç´„ã‚’è¨­å®š
                        const newSeat = findSeat(newSeatId);
                        if (newSeat) {
                            newSeat.status = status;
                            newSeat.customer = `${customerName}(${people}å)`;
                            newSeat.time = time;
                        }
                    } else {
                        // åŒã˜å¸­ã§æƒ…å ±ã‚’æ›´æ–°
                        reservation.customerName = customerName;
                        reservation.people = parseInt(people);
                        if (time) {
                            const [hours, minutes] = time.split(':');
                            const date = new Date(reservation.dateTime || reservation.createdAt);
                            date.setHours(parseInt(hours), parseInt(minutes));
                            reservation.dateTime = date.toISOString();
                        }
                        
                        // å¸­ã®çŠ¶æ…‹ã‚‚æ›´æ–°
                        const seat = findSeat(currentSeatId);
                        if (seat) {
                            seat.status = status;
                            seat.customer = `${customerName}(${people}å)`;
                            seat.time = time;
                        }
                    }
                    
                    // ã‚µãƒ¼ãƒãƒ¼ã«æ›´æ–°ã‚’é€ä¿¡
                    try {
                        await fetch('/api/reservations', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...reservation,
                                action: 'update'
                            })
                        });
                    } catch (err) {
                        console.error('Failed to update reservation:', err);
                    }
                }
            } else {
                // æ–°è¦äºˆç´„ã¾ãŸã¯æ‰‹å‹•ã§ã®å¸­çŠ¶æ…‹å¤‰æ›´
                const seat = findSeat(currentSeatId);
                if (seat) {
                    seat.status = status;
                    
                    if (customerName) {
                        seat.customer = `${customerName}(${people}å)`;
                        seat.time = time;
                        
                        // æ–°è¦äºˆç´„ã¨ã—ã¦ä¿å­˜
                        const newReservation = {
                            customerName: customerName,
                            people: parseInt(people),
                            seatId: currentSeatId,
                            dateTime: new Date().toISOString(),
                            source: 'manual',
                            notes: 'å¸­ã‹ã‚‰ç›´æ¥è¿½åŠ '
                        };
                        
                        if (time) {
                            const [hours, minutes] = time.split(':');
                            const date = new Date();
                            date.setHours(parseInt(hours), parseInt(minutes));
                            newReservation.dateTime = date.toISOString();
                        }
                        
                        try {
                            await fetch('/api/reservations', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(newReservation)
                            });
                            
                            // äºˆç´„ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                            await loadReservations();
                        } catch (err) {
                            console.error('Failed to save reservation:', err);
                        }
                    } else {
                        delete seat.customer;
                        delete seat.time;
                    }
                }
            }
            
            closeModal();
            renderSeats();
            updateStats();
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            // ã‚¿ãƒ–ã«å¿œã˜ãŸäºˆç´„ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        }
        
        // æ›´æ–°
        function refreshSeats() {
            renderSeats();
            renderReservations();
            updateStats();
        }
        
        // æ™‚åˆ»æ›´æ–°
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP');
            document.getElementById('currentTime').textContent = `â° ${timeStr}`;
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            alert('åº§å¸­ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™');
        }
        
        // å…¨å¸­ãƒªã‚»ãƒƒãƒˆ
        function clearAll() {
            if (confirm('å…¨å¸­ã‚’ç©ºå¸­çŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                Object.values(seatData).forEach(section => {
                    section.forEach(seat => {
                        seat.status = 'available';
                        delete seat.customer;
                        delete seat.time;
                    });
                });
                renderSeats();
                updateStats();
            }
        }
        
        // äºˆç´„ã®å¸­å‰²ã‚Šå½“ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showSeatAssignModal(reservationId) {
            const reservation = reservations.find(r => r.id === reservationId);
            if (!reservation) return;
            
            // ç°¡æ˜“çš„ãªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§å¸­ã‚’é¸æŠ
            const availableSeats = [];
            Object.entries(seatData).forEach(([section, seats]) => {
                const sectionName = section === 'counter' ? 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼' : 
                                   section === 'table' ? 'ãƒ†ãƒ¼ãƒ–ãƒ«' : 'å€‹å®¤';
                seats.forEach(seat => {
                    if (seat.status === 'available' && seat.capacity >= (reservation.people || 1)) {
                        availableSeats.push(`${seat.id} (${sectionName} ${seat.capacity}åå¸­)`);
                    }
                });
            });
            
            if (availableSeats.length === 0) {
                alert('åˆ©ç”¨å¯èƒ½ãªå¸­ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const seatOptions = availableSeats.join('\n');
            const selectedSeat = prompt(
                `${reservation.customerName}æ§˜ (${reservation.people}å) ã®å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„:\n\n${seatOptions}\n\nå¸­ç•ªå·ã‚’å…¥åŠ›:`,
                availableSeats[0].split(' ')[0]
            );
            
            if (selectedSeat) {
                // å¸­ã‚’å‰²ã‚Šå½“ã¦
                const seatId = selectedSeat.toUpperCase();
                const seat = findSeat(seatId);
                
                if (seat && seat.status === 'available') {
                    // äºˆç´„ã‚’æ›´æ–°
                    reservation.seatId = seatId;
                    
                    // å¸­ã®çŠ¶æ…‹ã‚’æ›´æ–°
                    seat.status = 'reserved';
                    seat.customer = `${reservation.customerName}(${reservation.people}å)`;
                    seat.time = formatTime(new Date(reservation.dateTime || reservation.createdAt));
                    
                    // ã‚µãƒ¼ãƒãƒ¼ã«æ›´æ–°ã‚’é€ä¿¡
                    fetch('/api/reservations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ...reservation,
                            action: 'update'
                        })
                    }).then(() => {
                        renderSeats();
                        renderReservations();
                        updateStats();
                    });
                } else {
                    alert('é¸æŠã—ãŸå¸­ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
            }
        }
        
        // æ–°è¦äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showReservationModal() {
            // ãƒ†ã‚¹ãƒˆç”¨ã®äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const testReservation = {
                customerName: prompt('ãŠå®¢æ§˜åï¼š', 'å±±ç”°å¤ªéƒ'),
                people: parseInt(prompt('äººæ•°ï¼š', '2')) || 2,
                dateTime: new Date(prompt('äºˆç´„æ™‚åˆ» (ä¾‹: 2024-08-24 19:00)ï¼š', 
                    new Date(Date.now() + 60*60*1000).toISOString().slice(0,16).replace('T', ' '))).toISOString(),
                phone: prompt('é›»è©±ç•ªå·ï¼š', 'LINEäºˆç´„'),
                notes: prompt('å‚™è€ƒï¼š', 'ç¦ç…™å¸­å¸Œæœ›'),
                source: 'manual'
            };
            
            if (testReservation.customerName) {
                // APIã«é€ä¿¡
                fetch('/api/reservations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testReservation)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('äºˆç´„ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
                        loadReservations(); // äºˆç´„ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                    } else {
                        alert('äºˆç´„ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            }
        }
    </script>
</body>
</html>