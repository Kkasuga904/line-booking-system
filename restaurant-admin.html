<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飲食店 席管理システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 統計カード */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .stat-card .label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-card .sub {
            color: #999;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* 席レイアウト */
        .floor-layout {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .floor-layout h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* 席の配置 */
        .seat-areas {
            display: grid;
            gap: 30px;
        }
        
        .seat-section {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            background: #fafafa;
        }
        
        .seat-section h3 {
            color: #555;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .seats-grid {
            display: grid;
            gap: 10px;
        }
        
        .counter-seats {
            grid-template-columns: repeat(8, 1fr);
        }
        
        .table-seats {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .private-seats {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .seat {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .seat.available {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .seat.occupied {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .seat.reserved {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .seat.cleaning {
            background: #d1ecf1;
            border-color: #17a2b8;
        }
        
        .seat:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .seat-id {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .seat-capacity {
            font-size: 12px;
            color: #666;
        }
        
        .seat-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        /* 予約リスト */
        .reservations-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .reservations-panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .reservation-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab.active {
            color: #FF6B6B;
            border-bottom-color: #FF6B6B;
            font-weight: 600;
        }
        
        .reservation-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .reservation-item {
            border-left: 4px solid #FF6B6B;
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s;
        }
        
        .reservation-item:hover {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .reservation-time {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        
        .reservation-seat {
            background: #FF6B6B;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .reservation-details {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* アクションボタン */
        .actions-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .current-time {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-weight: 600;
            color: #333;
        }
        
        @media (max-width: 768px) {
            .counter-seats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .table-seats,
            .private-seats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🍽️ レストラン席管理システム</h1>
            <div class="subtitle">リアルタイム空席状況・予約管理</div>
        </div>
    </div>
    
    <div class="current-time" id="currentTime"></div>
    
    <div class="container">
        <!-- 統計情報 -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="label">空席数</div>
                <div class="value" id="availableSeats">12</div>
                <div class="sub">/ 全16席</div>
            </div>
            <div class="stat-card">
                <div class="label">使用中</div>
                <div class="value" id="occupiedSeats">3</div>
                <div class="sub">18:30から</div>
            </div>
            <div class="stat-card">
                <div class="label">予約済</div>
                <div class="value" id="reservedSeats">1</div>
                <div class="sub">19:00～</div>
            </div>
            <div class="stat-card">
                <div class="label">本日の予約</div>
                <div class="value" id="todayReservations">8</div>
                <div class="sub">組</div>
            </div>
            <div class="stat-card">
                <div class="label">回転率</div>
                <div class="value">2.3</div>
                <div class="sub">回/日</div>
            </div>
        </div>
        
        <!-- 席レイアウト -->
        <div class="floor-layout">
            <h2>🗺️ フロアマップ</h2>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #d4edda;"></div>
                    <span>空席</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f8d7da;"></div>
                    <span>使用中</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff3cd;"></div>
                    <span>予約済</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d1ecf1;"></div>
                    <span>清掃中</span>
                </div>
            </div>
            
            <div class="seat-areas">
                <!-- カウンター席 -->
                <div class="seat-section">
                    <h3>🪑 カウンター席</h3>
                    <div class="seats-grid counter-seats" id="counterSeats">
                        <!-- JavaScriptで動的生成 -->
                    </div>
                </div>
                
                <!-- テーブル席 -->
                <div class="seat-section">
                    <h3>🪑🪑 テーブル席</h3>
                    <div class="seats-grid table-seats" id="tableSeats">
                        <!-- JavaScriptで動的生成 -->
                    </div>
                </div>
                
                <!-- 個室 -->
                <div class="seat-section">
                    <h3>🚪 個室</h3>
                    <div class="seats-grid private-seats" id="privateSeats">
                        <!-- JavaScriptで動的生成 -->
                    </div>
                </div>
            </div>
            
            <div class="actions-row">
                <button class="btn btn-primary" onclick="refreshSeats()">🔄 更新</button>
                <button class="btn btn-success" onclick="showReservationModal()">➕ 新規予約</button>
                <button class="btn btn-secondary" onclick="exportData()">📥 データ出力</button>
                <button class="btn btn-warning" onclick="clearAll()">🧹 全席リセット</button>
                <button class="btn btn-primary" onclick="window.open('/admin-send.html', '_blank')">📩 メッセージ送信</button>
                <button class="btn btn-secondary" onclick="window.location.href='/seat-config.html'">⚙️ 席配置設定</button>
            </div>
        </div>
        
        <!-- 予約リスト -->
        <div class="reservations-panel">
            <h2>📋 予約管理</h2>
            
            <div class="reservation-tabs">
                <button class="tab active" onclick="switchTab('waiting')">待ち (3)</button>
                <button class="tab" onclick="switchTab('today')">本日 (8)</button>
                <button class="tab" onclick="switchTab('tomorrow')">明日 (5)</button>
            </div>
            
            <div class="reservation-list" id="reservationList">
                <!-- JavaScriptで動的生成 -->
            </div>
        </div>
    </div>
    
    <!-- 席詳細モーダル -->
    <div class="modal" id="seatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">席の詳細</h2>
            </div>
            <div class="form-group">
                <label>席番号</label>
                <input type="text" id="modalSeatId" readonly>
            </div>
            <div class="form-group">
                <label>状態</label>
                <select id="modalStatus">
                    <option value="available">空席</option>
                    <option value="occupied">使用中</option>
                    <option value="reserved">予約済</option>
                    <option value="cleaning">清掃中</option>
                </select>
            </div>
            <div class="form-group">
                <label>お客様名</label>
                <input type="text" id="modalCustomer" placeholder="山田太郎">
            </div>
            <div class="form-group">
                <label>人数</label>
                <input type="number" id="modalPeople" min="1" max="10" value="2">
            </div>
            <div class="form-group">
                <label>時間</label>
                <input type="time" id="modalTime">
            </div>
            <div class="form-group">
                <label>席を移動</label>
                <select id="modalMoveSeat">
                    <option value="">席を移動しない</option>
                </select>
            </div>
            <div class="actions-row">
                <button class="btn btn-primary" onclick="saveSeat()">保存</button>
                <button class="btn btn-secondary" onclick="closeModal()">キャンセル</button>
            </div>
        </div>
    </div>
    
    <script>
        // 席データ
        const seatData = {
            counter: [
                { id: 'C1', capacity: 1, status: 'available' },
                { id: 'C2', capacity: 1, status: 'available' },
                { id: 'C3', capacity: 1, status: 'occupied', customer: '田中様', time: '18:30' },
                { id: 'C4', capacity: 1, status: 'available' },
                { id: 'C5', capacity: 1, status: 'available' },
                { id: 'C6', capacity: 1, status: 'available' },
                { id: 'C7', capacity: 1, status: 'occupied', customer: '佐藤様', time: '19:00' },
                { id: 'C8', capacity: 1, status: 'available' }
            ],
            table: [
                { id: 'T1', capacity: 4, status: 'available' },
                { id: 'T2', capacity: 4, status: 'available' },
                { id: 'T3', capacity: 4, status: 'occupied', customer: '鈴木様(3名)', time: '18:00' },
                { id: 'T4', capacity: 4, status: 'available' },
                { id: 'T5', capacity: 4, status: 'reserved', customer: '高橋様(4名)', time: '19:30' }
            ],
            private: [
                { id: 'P1', capacity: 6, status: 'available' },
                { id: 'P2', capacity: 8, status: 'cleaning' },
                { id: 'P3', capacity: 6, status: 'available' }
            ]
        };
        
        // 予約データ（APIから取得）
        let reservations = [];
        
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadSeatLayout();
            loadReservations();
            renderSeats();
            updateStats();
            updateTime();
            setInterval(updateTime, 1000);
            // 30秒ごとに予約データを自動更新
            setInterval(loadReservations, 30000);
        });
        
        // 席配置を読み込み
        async function loadSeatLayout() {
            try {
                // LocalStorageから取得（優先）
                const savedLayouts = localStorage.getItem('seatLayouts');
                if (savedLayouts) {
                    const layouts = JSON.parse(savedLayouts);
                    const storeId = localStorage.getItem('currentStoreId') || 'default';
                    
                    if (layouts[storeId]) {
                        seatData.counter = layouts[storeId].counter.map(s => ({
                            ...s,
                            status: 'available'
                        }));
                        seatData.table = layouts[storeId].table.map(s => ({
                            ...s,
                            status: 'available'
                        }));
                        seatData.private = layouts[storeId].private.map(s => ({
                            ...s,
                            status: 'available'
                        }));
                        
                        console.log('席配置をLocalStorageから読み込みました:', storeId);
                        return;
                    }
                }
                
                // サーバーから取得
                const response = await fetch('/api/seat-layout?storeId=default');
                const data = await response.json();
                
                if (data.layout) {
                    seatData.counter = data.layout.counter.map(s => ({
                        ...s,
                        status: 'available'
                    }));
                    seatData.table = data.layout.table.map(s => ({
                        ...s,
                        status: 'available'
                    }));
                    seatData.private = data.layout.private.map(s => ({
                        ...s,
                        status: 'available'
                    }));
                    
                    console.log('席配置をサーバーから読み込みました');
                }
            } catch (err) {
                console.log('カスタム席配置が見つかりません。デフォルトを使用します');
            }
        }
        
        // 予約データをAPIから取得
        async function loadReservations() {
            try {
                const response = await fetch('/api/reservations');
                const data = await response.json();
                reservations = data.reservations || [];
                
                // 予約データから席の状態を更新
                updateSeatStatusFromReservations();
                renderReservations();
                updateStats();
            } catch (err) {
                console.error('予約データの取得に失敗しました:', err);
            }
        }
        
        // 予約データから席の状態を更新
        function updateSeatStatusFromReservations() {
            // 全席を一旦利用可能にリセット
            Object.values(seatData).forEach(section => {
                section.forEach(seat => {
                    if (seat.status !== 'cleaning') {
                        seat.status = 'available';
                        delete seat.customer;
                        delete seat.time;
                    }
                });
            });
            
            // 予約データを反映
            const now = new Date();
            reservations.forEach(reservation => {
                if (reservation.status === 'cancelled') return;
                
                const reservationTime = new Date(reservation.dateTime || reservation.createdAt);
                const timeDiff = (reservationTime - now) / (1000 * 60); // 分単位
                
                // 現在時刻の前後2時間以内の予約を表示
                if (Math.abs(timeDiff) < 120) {
                    const seatId = reservation.seatId || assignSeat(reservation);
                    const seat = findSeat(seatId);
                    
                    if (seat) {
                        if (timeDiff < -30) {
                            // 30分以上前の予約は使用中
                            seat.status = 'occupied';
                        } else if (timeDiff < 30) {
                            // 30分以内の予約は予約済み
                            seat.status = 'reserved';
                        }
                        
                        seat.customer = `${reservation.customerName}(${reservation.people || 1}名)`;
                        seat.time = formatTime(reservationTime);
                    }
                }
            });
            
            renderSeats();
        }
        
        // 席を探す
        function findSeat(seatId) {
            for (const section of Object.values(seatData)) {
                const seat = section.find(s => s.id === seatId);
                if (seat) return seat;
            }
            return null;
        }
        
        // 自動的に席を割り当て
        function assignSeat(reservation) {
            const people = reservation.people || 1;
            
            // 人数に応じて適切な席を探す
            if (people <= 1) {
                // カウンター席優先
                const available = seatData.counter.find(s => s.status === 'available');
                if (available) {
                    reservation.seatId = available.id;
                    return available.id;
                }
            } else if (people <= 4) {
                // テーブル席
                const available = seatData.table.find(s => s.status === 'available');
                if (available) {
                    reservation.seatId = available.id;
                    return available.id;
                }
            } else {
                // 個室
                const available = seatData.private.find(s => s.status === 'available');
                if (available) {
                    reservation.seatId = available.id;
                    return available.id;
                }
            }
            
            // 空席がない場合は仮の席番号
            return 'W' + people; // Waiting
        }
        
        // 時刻フォーマット
        function formatTime(date) {
            const d = new Date(date);
            return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // 席の描画
        function renderSeats() {
            // カウンター席
            const counterContainer = document.getElementById('counterSeats');
            counterContainer.innerHTML = seatData.counter.map(seat => 
                createSeatElement(seat)
            ).join('');
            
            // テーブル席
            const tableContainer = document.getElementById('tableSeats');
            tableContainer.innerHTML = seatData.table.map(seat => 
                createSeatElement(seat)
            ).join('');
            
            // 個室
            const privateContainer = document.getElementById('privateSeats');
            privateContainer.innerHTML = seatData.private.map(seat => 
                createSeatElement(seat)
            ).join('');
        }
        
        // 席要素の作成
        function createSeatElement(seat) {
            return `
                <div class="seat ${seat.status}" onclick="showSeatDetails('${seat.id}')">
                    <div class="seat-id">${seat.id}</div>
                    <div class="seat-capacity">${seat.capacity}名席</div>
                    ${seat.customer ? `<div class="seat-time">${seat.customer}</div>` : ''}
                    ${seat.time ? `<div class="seat-time">${seat.time}～</div>` : ''}
                </div>
            `;
        }
        
        // 予約リストの描画
        function renderReservations() {
            const container = document.getElementById('reservationList');
            
            // 今日の予約のみフィルタリング
            const today = new Date();
            const todayReservations = reservations.filter(r => {
                const rDate = new Date(r.dateTime || r.createdAt);
                return rDate.toDateString() === today.toDateString() && r.status !== 'cancelled';
            });
            
            // 時間でソート
            todayReservations.sort((a, b) => {
                const aTime = new Date(a.dateTime || a.createdAt);
                const bTime = new Date(b.dateTime || b.createdAt);
                return aTime - bTime;
            });
            
            container.innerHTML = todayReservations.map(reservation => {
                const time = formatTime(new Date(reservation.dateTime || reservation.createdAt));
                const seatId = reservation.seatId || 'W';
                
                return `
                    <div class="reservation-item" data-reservation-id="${reservation.id}">
                        <div class="reservation-header">
                            <div class="reservation-time">${time}</div>
                            <div class="reservation-seat" style="cursor: pointer;" onclick="showSeatAssignModal('${reservation.id}')">${seatId} ✏️</div>
                        </div>
                        <div class="reservation-details">
                            👤 ${reservation.customerName || '名前なし'} (${reservation.people || 1}名)<br>
                            📱 ${reservation.phone || 'LINE予約'}<br>
                            💬 ${reservation.notes || '特記事項なし'}
                        </div>
                    </div>
                `;
            }).join('') || '<p style="text-align: center; color: #999;">本日の予約はありません</p>';
        }
        
        // 統計更新
        function updateStats() {
            let available = 0, occupied = 0, reserved = 0;
            
            Object.values(seatData).forEach(section => {
                section.forEach(seat => {
                    if (seat.status === 'available') available++;
                    else if (seat.status === 'occupied') occupied++;
                    else if (seat.status === 'reserved') reserved++;
                });
            });
            
            document.getElementById('availableSeats').textContent = available;
            document.getElementById('occupiedSeats').textContent = occupied;
            document.getElementById('reservedSeats').textContent = reserved;
        }
        
        // 席詳細表示
        function showSeatDetails(seatId) {
            const modal = document.getElementById('seatModal');
            const seat = findSeat(seatId);
            
            document.getElementById('modalSeatId').value = seatId;
            
            // 現在の席の状態を表示
            if (seat) {
                document.getElementById('modalStatus').value = seat.status;
                
                // 予約情報がある場合
                const reservation = findReservationBySeat(seatId);
                if (reservation) {
                    document.getElementById('modalCustomer').value = reservation.customerName || '';
                    document.getElementById('modalPeople').value = reservation.people || 1;
                    document.getElementById('modalTime').value = formatTimeForInput(new Date(reservation.dateTime || reservation.createdAt));
                    
                    // 予約IDを保存（席移動用）
                    modal.dataset.reservationId = reservation.id;
                } else {
                    document.getElementById('modalCustomer').value = '';
                    document.getElementById('modalPeople').value = 2;
                    document.getElementById('modalTime').value = '';
                    delete modal.dataset.reservationId;
                }
            }
            
            // 席移動オプションを追加
            updateSeatMoveOptions(seatId);
            
            modal.classList.add('show');
        }
        
        // 予約を席で検索
        function findReservationBySeat(seatId) {
            return reservations.find(r => r.seatId === seatId && r.status !== 'cancelled');
        }
        
        // 時刻を入力フォーマットに変換
        function formatTimeForInput(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // 席移動オプションを更新
        function updateSeatMoveOptions(currentSeatId) {
            const moveSelect = document.getElementById('modalMoveSeat');
            if (!moveSelect) return;
            
            moveSelect.innerHTML = '<option value="">席を移動しない</option>';
            
            // 空いている席をオプションに追加
            Object.entries(seatData).forEach(([section, seats]) => {
                const sectionName = section === 'counter' ? 'カウンター' : 
                                   section === 'table' ? 'テーブル' : '個室';
                
                seats.forEach(seat => {
                    if (seat.id !== currentSeatId && seat.status === 'available') {
                        const option = document.createElement('option');
                        option.value = seat.id;
                        option.textContent = `${sectionName} - ${seat.id} (${seat.capacity}名席)`;
                        moveSelect.appendChild(option);
                    }
                });
            });
        }
        
        // モーダルを閉じる
        function closeModal() {
            document.getElementById('seatModal').classList.remove('show');
        }
        
        // 席情報保存
        async function saveSeat() {
            const modal = document.getElementById('seatModal');
            const currentSeatId = document.getElementById('modalSeatId').value;
            const newSeatId = document.getElementById('modalMoveSeat').value;
            const status = document.getElementById('modalStatus').value;
            const customerName = document.getElementById('modalCustomer').value;
            const people = document.getElementById('modalPeople').value;
            const time = document.getElementById('modalTime').value;
            
            // 予約IDがある場合（既存の予約）
            const reservationId = modal.dataset.reservationId;
            
            if (reservationId) {
                // 予約を更新
                const reservation = reservations.find(r => r.id === reservationId);
                if (reservation) {
                    // 席を移動する場合
                    if (newSeatId) {
                        reservation.seatId = newSeatId;
                        
                        // 元の席を空席に
                        const oldSeat = findSeat(currentSeatId);
                        if (oldSeat) {
                            oldSeat.status = 'available';
                            delete oldSeat.customer;
                            delete oldSeat.time;
                        }
                        
                        // 新しい席に予約を設定
                        const newSeat = findSeat(newSeatId);
                        if (newSeat) {
                            newSeat.status = status;
                            newSeat.customer = `${customerName}(${people}名)`;
                            newSeat.time = time;
                        }
                    } else {
                        // 同じ席で情報を更新
                        reservation.customerName = customerName;
                        reservation.people = parseInt(people);
                        if (time) {
                            const [hours, minutes] = time.split(':');
                            const date = new Date(reservation.dateTime || reservation.createdAt);
                            date.setHours(parseInt(hours), parseInt(minutes));
                            reservation.dateTime = date.toISOString();
                        }
                        
                        // 席の状態も更新
                        const seat = findSeat(currentSeatId);
                        if (seat) {
                            seat.status = status;
                            seat.customer = `${customerName}(${people}名)`;
                            seat.time = time;
                        }
                    }
                    
                    // サーバーに更新を送信
                    try {
                        await fetch('/api/reservations', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...reservation,
                                action: 'update'
                            })
                        });
                    } catch (err) {
                        console.error('Failed to update reservation:', err);
                    }
                }
            } else {
                // 新規予約または手動での席状態変更
                const seat = findSeat(currentSeatId);
                if (seat) {
                    seat.status = status;
                    
                    if (customerName) {
                        seat.customer = `${customerName}(${people}名)`;
                        seat.time = time;
                        
                        // 新規予約として保存
                        const newReservation = {
                            customerName: customerName,
                            people: parseInt(people),
                            seatId: currentSeatId,
                            dateTime: new Date().toISOString(),
                            source: 'manual',
                            notes: '席から直接追加'
                        };
                        
                        if (time) {
                            const [hours, minutes] = time.split(':');
                            const date = new Date();
                            date.setHours(parseInt(hours), parseInt(minutes));
                            newReservation.dateTime = date.toISOString();
                        }
                        
                        try {
                            await fetch('/api/reservations', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(newReservation)
                            });
                            
                            // 予約リストを再読み込み
                            await loadReservations();
                        } catch (err) {
                            console.error('Failed to save reservation:', err);
                        }
                    } else {
                        delete seat.customer;
                        delete seat.time;
                    }
                }
            }
            
            closeModal();
            renderSeats();
            updateStats();
        }
        
        // タブ切り替え
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            // タブに応じた予約リストを表示
        }
        
        // 更新
        function refreshSeats() {
            renderSeats();
            renderReservations();
            updateStats();
        }
        
        // 時刻更新
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP');
            document.getElementById('currentTime').textContent = `⏰ ${timeStr}`;
        }
        
        // データエクスポート
        function exportData() {
            alert('座席データをCSVでエクスポートします');
        }
        
        // 全席リセット
        function clearAll() {
            if (confirm('全席を空席状態にリセットしますか？')) {
                Object.values(seatData).forEach(section => {
                    section.forEach(seat => {
                        seat.status = 'available';
                        delete seat.customer;
                        delete seat.time;
                    });
                });
                renderSeats();
                updateStats();
            }
        }
        
        // 予約の席割り当てモーダル表示
        function showSeatAssignModal(reservationId) {
            const reservation = reservations.find(r => r.id === reservationId);
            if (!reservation) return;
            
            // 簡易的なダイアログで席を選択
            const availableSeats = [];
            Object.entries(seatData).forEach(([section, seats]) => {
                const sectionName = section === 'counter' ? 'カウンター' : 
                                   section === 'table' ? 'テーブル' : '個室';
                seats.forEach(seat => {
                    if (seat.status === 'available' && seat.capacity >= (reservation.people || 1)) {
                        availableSeats.push(`${seat.id} (${sectionName} ${seat.capacity}名席)`);
                    }
                });
            });
            
            if (availableSeats.length === 0) {
                alert('利用可能な席がありません');
                return;
            }
            
            const seatOptions = availableSeats.join('\n');
            const selectedSeat = prompt(
                `${reservation.customerName}様 (${reservation.people}名) の席を選択してください:\n\n${seatOptions}\n\n席番号を入力:`,
                availableSeats[0].split(' ')[0]
            );
            
            if (selectedSeat) {
                // 席を割り当て
                const seatId = selectedSeat.toUpperCase();
                const seat = findSeat(seatId);
                
                if (seat && seat.status === 'available') {
                    // 予約を更新
                    reservation.seatId = seatId;
                    
                    // 席の状態を更新
                    seat.status = 'reserved';
                    seat.customer = `${reservation.customerName}(${reservation.people}名)`;
                    seat.time = formatTime(new Date(reservation.dateTime || reservation.createdAt));
                    
                    // サーバーに更新を送信
                    fetch('/api/reservations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ...reservation,
                            action: 'update'
                        })
                    }).then(() => {
                        renderSeats();
                        renderReservations();
                        updateStats();
                    });
                } else {
                    alert('選択した席は利用できません');
                }
            }
        }
        
        // 新規予約モーダル
        function showReservationModal() {
            // テスト用の予約データを作成
            const testReservation = {
                customerName: prompt('お客様名：', '山田太郎'),
                people: parseInt(prompt('人数：', '2')) || 2,
                dateTime: new Date(prompt('予約時刻 (例: 2024-08-24 19:00)：', 
                    new Date(Date.now() + 60*60*1000).toISOString().slice(0,16).replace('T', ' '))).toISOString(),
                phone: prompt('電話番号：', 'LINE予約'),
                notes: prompt('備考：', '禁煙席希望'),
                source: 'manual'
            };
            
            if (testReservation.customerName) {
                // APIに送信
                fetch('/api/reservations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testReservation)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('予約を追加しました！');
                        loadReservations(); // 予約リストを再読み込み
                    } else {
                        alert('予約の追加に失敗しました');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('エラーが発生しました');
                });
            }
        }
    </script>
</body>
</html>