# LINE予約システム マルチテナント設定

upstream tenant_a {
    server tenant-a:3001;
}

upstream tenant_b {
    server tenant-b:3002;
}

upstream tenant_c {
    server tenant-c:3003;
}

server {
    listen 80;
    server_name app.yourdomain.com localhost;

    # セキュリティヘッダー
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # テナントA
    location /tenant-a/ {
        proxy_pass http://tenant_a/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # LINE Webhook用の設定
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        client_max_body_size 10M;
    }

    # テナントB
    location /tenant-b/ {
        proxy_pass http://tenant_b/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        client_max_body_size 10M;
    }

    # テナントC
    location /tenant-c/ {
        proxy_pass http://tenant_c/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        client_max_body_size 10M;
    }

    # ヘルスチェック
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ルートパス
    location / {
        return 200 '
<!DOCTYPE html>
<html>
<head>
    <title>LINE Booking System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        h1 { color: #06C755; }
        .tenant-list {
            list-style: none;
            padding: 0;
        }
        .tenant-list li {
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .tenant-list a {
            color: #06C755;
            text-decoration: none;
            font-weight: bold;
        }
        .webhook-url {
            background: #e8f4ea;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            display: inline-block;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>LINE Booking System - Multi-Tenant</h1>
    <h2>Active Tenants:</h2>
    <ul class="tenant-list">
        <li>
            <a href="/tenant-a/admin">Tenant A Admin</a>
            <div class="webhook-url">Webhook: https://app.yourdomain.com/tenant-a/webhook</div>
        </li>
        <li>
            <a href="/tenant-b/admin">Tenant B Admin</a>
            <div class="webhook-url">Webhook: https://app.yourdomain.com/tenant-b/webhook</div>
        </li>
        <li>
            <a href="/tenant-c/admin">Tenant C Admin</a>
            <div class="webhook-url">Webhook: https://app.yourdomain.com/tenant-c/webhook</div>
        </li>
    </ul>
</body>
</html>
        ';
        add_header Content-Type text/html;
    }
}

# HTTPS設定（Let's Encrypt使用時）
server {
    listen 443 ssl http2;
    server_name app.yourdomain.com;

    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    
    # SSL設定
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # HSTSヘッダー
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # その他の設定は80番ポートと同じ
    include /etc/nginx/conf.d/line-booking-locations.conf;
}