<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="0; url=/capacity-control-enhanced.html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</title>
    <script>
        window.location.href = '/capacity-control-enhanced.html';
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            color: #555;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #f8f9fa;
            border-color: #4a90e2;
            color: #4a90e2;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* è¨­å®šãƒ‘ãƒãƒ« */
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ— */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .required {
            color: #e74c3c;
        }

        input[type="date"],
        input[type="time"],
        input[type="number"],
        select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        /* æ™‚é–“ç¯„å›²ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
        .time-range-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .time-range-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .time-display {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .time-slider {
            position: relative;
            height: 50px;
            background: linear-gradient(to right, #e8f4fd 0%, #4a90e2 0%, #4a90e2 100%, #e8f4fd 100%);
            border-radius: 25px;
            margin: 20px 0;
        }

        .slider-handle {
            position: absolute;
            width: 30px;
            height: 30px;
            background: white;
            border: 3px solid #4a90e2;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .slider-handle:active {
            cursor: grabbing;
        }

        .slider-handle.start {
            left: 30%;
        }

        .slider-handle.end {
            left: 70%;
        }

        .time-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            color: #666;
            font-size: 12px;
        }

        /* åˆ¶å¾¡ã‚¿ã‚¤ãƒ—é¸æŠ */
        .control-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-type {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .control-type:hover {
            border-color: #4a90e2;
            background: #f8f9fa;
        }

        .control-type.active {
            border-color: #4a90e2;
            background: #e8f4fd;
        }

        .control-type-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .control-type-label {
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
        }

        .control-type-desc {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* æ™‚é–“å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
        input[type="time"] {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            /* 24æ™‚é–“è¡¨è¨˜ã‚’å¼·åˆ¶ */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            position: relative;
            background: white;
        }
        
        /* Chrome/Safariç”¨ - AM/PMã‚’å®Œå…¨ã«éè¡¨ç¤º */
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            display: none !important;
            visibility: hidden !important;
            width: 0 !important;
            height: 0 !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        input[type="time"]::-webkit-datetime-edit-text {
            padding: 0 2px;
        }
        
        input[type="time"]::-webkit-datetime-edit-hour-field {
            color: #333;
        }
        
        input[type="time"]::-webkit-datetime-edit-minute-field {
            color: #333;
        }
        
        input[type="time"]::-webkit-inner-spin-button {
            display: none;
        }
        
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: transparent;
            color: transparent;
            cursor: pointer;
            position: absolute;
            right: 0;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        
        /* Firefoxç”¨ */
        @-moz-document url-prefix() {
            input[type="time"] {
                -moz-appearance: textfield;
            }
        }
        
        /* Edgeç”¨ */
        input[type="time"]::-ms-clear {
            display: none;
        }

        /* æ•°å€¤å…¥åŠ› */
        .limit-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .limit-input {
            width: 100px;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
        }

        .limit-unit {
            font-size: 16px;
            color: #555;
        }

        /* è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
        .additional-options {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .option-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        /* ç™»éŒ²æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ä¸€è¦§ */
        .saved-controls {
            margin-top: 40px;
        }

        .saved-controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .saved-controls-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
        }

        .filter-tab {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-tab.active {
            background: #4a90e2;
            color: white;
            border-color: #4a90e2;
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .control-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
            position: relative;
        }

        .control-card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .card-date {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .card-time {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .card-limits {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .limit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .limit-item:last-child {
            margin-bottom: 0;
        }

        .limit-label {
            color: #666;
            font-size: 13px;
        }

        .limit-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .card-btn {
            flex: 1;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .card-btn:hover {
            background: #f8f9fa;
        }

        .card-btn.edit {
            color: #4a90e2;
            border-color: #4a90e2;
        }

        .card-btn.delete {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .card-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-upcoming {
            background: #fff3cd;
            color: #856404;
        }

        .status-past {
            background: #f8d7da;
            color: #721c24;
        }

        /* ç©ºçŠ¶æ…‹ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-subtext {
            font-size: 14px;
            color: #aaa;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .control-type-selector {
                flex-direction: column;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.warning {
            border-left: 4px solid #f39c12;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="header-content">
            <h1>
                ğŸ¯ äºˆç´„åˆ¶å¾¡è¨­å®š
                <span style="font-size: 14px; color: #666; font-weight: normal;">æ—¥ä»˜ãƒ»æ™‚é–“å¸¯ãƒ»äººæ•°ã§ç´°ã‹ãç®¡ç†</span>
            </h1>
            <div class="nav-buttons">
                <a href="/admin" class="nav-btn">ğŸ“‹ ç®¡ç†ç”»é¢</a>
                <a href="/admin-calendar" class="nav-btn">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
                <a href="/dashboard.html" class="nav-btn">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="container">
        <!-- æ–°è¦è¨­å®šãƒ‘ãƒãƒ« -->
        <div class="control-panel">
            <h2 class="panel-title">æ–°è¦åˆ¶å¾¡ãƒ«ãƒ¼ãƒ«ä½œæˆ</h2>

            <!-- æ—¥ä»˜ç¯„å›²é¸æŠ -->
            <div class="date-mode-selector">
                <label class="form-label">ğŸ“… é©ç”¨æœŸé–“ã®è¨­å®šæ–¹æ³•</label>
                <div class="control-type-selector">
                    <div class="control-type active" data-mode="single">
                        <div class="control-type-icon">ğŸ“…</div>
                        <div class="control-type-label">å˜æ—¥æŒ‡å®š</div>
                        <div class="control-type-desc">1ã¤ã®æ—¥ä»˜ã®ã¿</div>
                    </div>
                    <div class="control-type" data-mode="range">
                        <div class="control-type-icon">ğŸ“†</div>
                        <div class="control-type-label">æœŸé–“æŒ‡å®š</div>
                        <div class="control-type-desc">é–‹å§‹æ—¥ã‹ã‚‰çµ‚äº†æ—¥ã¾ã§</div>
                    </div>
                    <div class="control-type" data-mode="weekly">
                        <div class="control-type-icon">ğŸ—“ï¸</div>
                        <div class="control-type-label">æ›œæ—¥æŒ‡å®š</div>
                        <div class="control-type-desc">åŒã˜æ›œæ—¥ã™ã¹ã¦</div>
                    </div>
                </div>
            </div>

            <!-- æ—¥ä»˜ã¨åŸºæœ¬è¨­å®š -->
            <div class="form-row" id="dateInputsContainer">
                <!-- å˜æ—¥æŒ‡å®š -->
                <div class="form-group" id="singleDateGroup">
                    <label class="form-label">
                        ğŸ“… å¯¾è±¡æ—¥ä»˜ <span class="required">*</span>
                    </label>
                    <input type="date" id="targetDate" min="">
                </div>
                
                <!-- æœŸé–“æŒ‡å®š -->
                <div class="form-group" id="startDateGroup" style="display: none;">
                    <label class="form-label">
                        ğŸ“… é–‹å§‹æ—¥ <span class="required">*</span>
                    </label>
                    <input type="date" id="startDate" min="">
                </div>
                <div class="form-group" id="endDateGroup" style="display: none;">
                    <label class="form-label">
                        ğŸ“… çµ‚äº†æ—¥ <span class="required">*</span>
                    </label>
                    <input type="date" id="endDate" min="">
                </div>
                
                <!-- æ›œæ—¥æŒ‡å®š -->
                <div class="form-group" id="weekdayGroup" style="display: none;">
                    <label class="form-label">
                        ğŸ“… å¯¾è±¡æ›œæ—¥ <span class="required">*</span>
                    </label>
                    <select id="targetWeekday" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <option value="1">æœˆæ›œæ—¥</option>
                        <option value="2">ç«æ›œæ—¥</option>
                        <option value="3">æ°´æ›œæ—¥</option>
                        <option value="4">æœ¨æ›œæ—¥</option>
                        <option value="5">é‡‘æ›œæ—¥</option>
                        <option value="6">åœŸæ›œæ—¥</option>
                        <option value="0">æ—¥æ›œæ—¥</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        ğŸ·ï¸ ãƒ«ãƒ¼ãƒ«åï¼ˆä»»æ„ï¼‰
                    </label>
                    <input type="text" id="ruleName" placeholder="ä¾‹ï¼šGWæœŸé–“ãƒ‡ã‚£ãƒŠãƒ¼åˆ¶é™">
                </div>
            </div>

            <!-- æ™‚é–“ç¯„å›²è¨­å®š -->
            <div class="time-range-container">
                <div class="time-range-header">
                    <span class="form-label">â° å¯¾è±¡æ™‚é–“å¸¯</span>
                    <span class="time-display" id="timeDisplay">18:00 - 21:00</span>
                </div>
                
                <!-- æ™‚é–“å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">é–‹å§‹æ™‚åˆ»</label>
                        <input type="time" id="startTime" value="18:00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">çµ‚äº†æ™‚åˆ»</label>
                        <input type="time" id="endTime" value="21:00">
                    </div>
                </div>
            </div>

            <!-- åˆ¶å¾¡ã‚¿ã‚¤ãƒ—é¸æŠ -->
            <label class="form-label" style="margin-bottom: 15px;">åˆ¶å¾¡æ–¹æ³•ã‚’é¸æŠ</label>
            <div class="control-type-selector">
                <div class="control-type active" data-type="groups">
                    <div class="control-type-icon">ğŸ‘¥</div>
                    <div class="control-type-label">çµ„æ•°ã§åˆ¶é™</div>
                    <div class="control-type-desc">â—¯çµ„ã¾ã§ã¨è¨­å®š</div>
                </div>
                <div class="control-type" data-type="people">
                    <div class="control-type-icon">ğŸ‘¤</div>
                    <div class="control-type-label">äººæ•°ã§åˆ¶é™</div>
                    <div class="control-type-desc">åˆè¨ˆâ—¯äººã¾ã§ã¨è¨­å®š</div>
                </div>
                <div class="control-type" data-type="both">
                    <div class="control-type-icon">âš¡</div>
                    <div class="control-type-label">ä¸¡æ–¹ã§åˆ¶é™</div>
                    <div class="control-type-desc">çµ„æ•°ã¨äººæ•°ä¸¡æ–¹</div>
                </div>
            </div>

            <!-- æ•°å€¤è¨­å®š -->
            <div id="limitInputs">
                <div class="limit-input-group" id="groupsLimit">
                    <label class="form-label" style="margin: 0;">æœ€å¤§çµ„æ•°ï¼š</label>
                    <input type="number" class="limit-input" id="maxGroups" value="10" min="1">
                    <span class="limit-unit">çµ„ã¾ã§</span>
                </div>
                <div class="limit-input-group" id="peopleLimit" style="display: none;">
                    <label class="form-label" style="margin: 0;">æœ€å¤§äººæ•°ï¼š</label>
                    <input type="number" class="limit-input" id="maxPeople" value="40" min="1">
                    <span class="limit-unit">äººã¾ã§</span>
                </div>
            </div>

            <!-- è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
            <div class="additional-options">
                <div class="option-item">
                    <input type="checkbox" class="option-checkbox" id="limitPerGroup">
                    <label for="limitPerGroup">1çµ„ã‚ãŸã‚Šã®æœ€å¤§äººæ•°ã‚’åˆ¶é™</label>
                    <input type="number" id="maxPerGroup" value="8" min="1" style="width: 60px; margin-left: 10px;" disabled>
                    <span class="limit-unit">äººã¾ã§</span>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveControl()">
                    ğŸ’¾ ãƒ«ãƒ¼ãƒ«ã‚’ä¿å­˜
                </button>
                <button class="btn btn-secondary" onclick="resetForm()">
                    ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
        </div>

        <!-- ç™»éŒ²æ¸ˆã¿ãƒ«ãƒ¼ãƒ«ä¸€è¦§ -->
        <div class="saved-controls">
            <div class="saved-controls-header">
                <h2 class="saved-controls-title">ç™»éŒ²æ¸ˆã¿ãƒ«ãƒ¼ãƒ«</h2>
                <div class="filter-tabs">
                    <div class="filter-tab active" data-filter="all">ã™ã¹ã¦</div>
                    <div class="filter-tab" data-filter="active">æœ‰åŠ¹</div>
                    <div class="filter-tab" data-filter="upcoming">ä»Šå¾Œ</div>
                    <div class="filter-tab" data-filter="past">éå»</div>
                </div>
            </div>

            <div class="cards-grid" id="cardsGrid">
                <!-- ã‚«ãƒ¼ãƒ‰ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </div>

            <!-- ç©ºçŠ¶æ…‹ -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">ğŸ“­</div>
                <div class="empty-text">ã¾ã ãƒ«ãƒ¼ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                <div class="empty-subtext">ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ–°ã—ã„ãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„</div>
            </div>
        </div>
    </div>

    <script>
        // å®šæ•°
        const STORE_ID = localStorage.getItem('store_id') || 'default-store';
        const API_BASE = '/api';
        
        // çŠ¶æ…‹ç®¡ç†
        let currentControlType = 'groups';
        let currentDateMode = 'single';
        let savedRules = [];
        
        // LocalStorageã‚­ãƒ¼åã‚’çµ±ä¸€ï¼ˆãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ãã™ã‚‹ï¼‰
        const STORAGE_KEY = 'capacityRules';

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeDatePicker();
            setupEventListeners();
            loadSavedRules();
            updateTimeDisplay();
            force24HourFormat();
        });

        // æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼ã®åˆæœŸåŒ–
        function initializeDatePicker() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            
            // å„æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸåŒ–
            const targetDate = document.getElementById('targetDate');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            // æœ€å°æ—¥ä»˜ã‚’ä»Šæ—¥ã«è¨­å®š
            [targetDate, startDate, endDate].forEach(input => {
                input.min = dateStr;
            });
            
            // åˆæœŸå€¤è¨­å®š
            targetDate.value = dateStr;
            startDate.value = dateStr;
            
            // çµ‚äº†æ—¥ã‚’1é€±é–“å¾Œã«è¨­å®š
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            endDate.value = nextWeek.toISOString().split('T')[0];
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // æ—¥ä»˜ãƒ¢ãƒ¼ãƒ‰é¸æŠ
            document.querySelectorAll('[data-mode]').forEach(mode => {
                mode.addEventListener('click', () => {
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã®æ›´æ–°
                    document.querySelectorAll('[data-mode]').forEach(m => m.classList.remove('active'));
                    mode.classList.add('active');
                    
                    // æ—¥ä»˜ãƒ¢ãƒ¼ãƒ‰ã®æ›´æ–°
                    currentDateMode = mode.dataset.mode;
                    updateDateInputs();
                });
            });
            
            // åˆ¶å¾¡ã‚¿ã‚¤ãƒ—é¸æŠ
            document.querySelectorAll('.control-type[data-type]').forEach(type => {
                type.addEventListener('click', () => {
                    document.querySelectorAll('.control-type[data-type]').forEach(t => t.classList.remove('active'));
                    type.classList.add('active');
                    currentControlType = type.dataset.type;
                    updateLimitInputs();
                });
            });

            // æ™‚é–“å¤‰æ›´ç›£è¦–
            document.getElementById('startTime').addEventListener('change', updateTimeDisplay);
            document.getElementById('endTime').addEventListener('change', updateTimeDisplay);

            // 1çµ„ã‚ãŸã‚Šåˆ¶é™ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            document.getElementById('limitPerGroup').addEventListener('change', (e) => {
                document.getElementById('maxPerGroup').disabled = !e.target.checked;
            });

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filterCards(tab.dataset.filter);
                });
            });
        }

        // æ—¥ä»˜å…¥åŠ›ã®è¡¨ç¤ºåˆ‡æ›¿
        function updateDateInputs() {
            const singleDateGroup = document.getElementById('singleDateGroup');
            const startDateGroup = document.getElementById('startDateGroup');
            const endDateGroup = document.getElementById('endDateGroup');
            const weekdayGroup = document.getElementById('weekdayGroup');
            
            // å…¨ã¦éè¡¨ç¤ºã«ã™ã‚‹
            [singleDateGroup, startDateGroup, endDateGroup, weekdayGroup].forEach(group => {
                group.style.display = 'none';
            });
            
            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦è¡¨ç¤º
            if (currentDateMode === 'single') {
                singleDateGroup.style.display = 'block';
            } else if (currentDateMode === 'range') {
                startDateGroup.style.display = 'block';
                endDateGroup.style.display = 'block';
            } else if (currentDateMode === 'weekly') {
                weekdayGroup.style.display = 'block';
            }
        }
        
        // åˆ¶é™å…¥åŠ›ã®è¡¨ç¤ºåˆ‡æ›¿
        function updateLimitInputs() {
            const groupsLimit = document.getElementById('groupsLimit');
            const peopleLimit = document.getElementById('peopleLimit');
            
            if (currentControlType === 'groups') {
                groupsLimit.style.display = 'flex';
                peopleLimit.style.display = 'none';
            } else if (currentControlType === 'people') {
                groupsLimit.style.display = 'none';
                peopleLimit.style.display = 'flex';
            } else if (currentControlType === 'both') {
                groupsLimit.style.display = 'flex';
                peopleLimit.style.display = 'flex';
            }
        }

        // æ™‚é–“è¡¨ç¤ºã®æ›´æ–°
        function updateTimeDisplay() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            document.getElementById('timeDisplay').textContent = `${startTime} - ${endTime}`;
        }

        // å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šæœ€åˆã«è¦‹ã¤ã‹ã£ãŸå€¤ã‚’è¿”ã™
        function pickInputValue(selectors) {
            for (const sel of selectors) {
                const el = document.querySelector(sel);
                if (el && el.value != null) return String(el.value).trim();
            }
            return "";
        }

        // ãƒ«ãƒ¼ãƒ«ä¿å­˜
        async function saveControl() {
            // æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            let dateInfo = {};
            if (currentDateMode === 'single') {
                dateInfo.date = document.getElementById('targetDate').value;
                dateInfo.dateMode = 'single';
            } else if (currentDateMode === 'range') {
                dateInfo.startDate = document.getElementById('startDate').value;
                dateInfo.endDate = document.getElementById('endDate').value;
                dateInfo.dateMode = 'range';
            } else if (currentDateMode === 'weekly') {
                dateInfo.weekday = parseInt(document.getElementById('targetWeekday').value);
                dateInfo.dateMode = 'weekly';
            }
            
            // ã‚»ãƒ¬ã‚¯ã‚¿ã®æºã‚Œã‚’è¨±å®¹
            const rawStart = pickInputValue([
                "#startTime","input[name='startTime']",
                "#ruleStartTime","input[name='ruleStartTime']",
                "[data-field='startTime']"
            ]);
            const rawEnd = pickInputValue([
                "#endTime","input[name='endTime']",
                "#ruleEndTime","input[name='ruleEndTime']",
                "[data-field='endTime']"
            ]);

            const isAllDay = currentDateMode === "allday";
            const ns = normalizeHHMMAny(rawStart);
            const ne = normalizeHHMMAny(rawEnd);

            if (!isAllDay && (!ns || !ne)) {
                alert(`é–‹å§‹/çµ‚äº†æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆHH:mmï¼‰\nå–å¾—: start='${rawStart}', end='${rawEnd}'`);
                return;
            }
            
            const finalStart = isAllDay ? "00:00" : ns;
            const finalEnd = isAllDay ? "23:59" : ne;
            
            const rule = {
                ...dateInfo,
                id: Date.now(), // Generate unique ID
                name: document.getElementById('ruleName').value || `${currentDateMode}åˆ¶å¾¡ãƒ«ãƒ¼ãƒ«`,
                startTime: finalStart,
                endTime: finalEnd,
                controlType: currentControlType,
                maxGroups: currentControlType !== 'people' ? parseInt(document.getElementById('maxGroups').value) : null,
                maxPeople: currentControlType !== 'groups' ? parseInt(document.getElementById('maxPeople').value) : null,
                maxPerGroup: document.getElementById('limitPerGroup').checked ? parseInt(document.getElementById('maxPerGroup').value) : null,
                createdAt: new Date().toISOString(),
                schemaVersion: 2
            };

            try {
                // APIã«ä¿å­˜ã‚’è©¦è¡Œ
                const response = await fetch(`${API_BASE}/capacity-control/rules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        store_id: STORE_ID,
                        ...rule
                    })
                });

                if (response.ok) {
                    // APIä¿å­˜æˆåŠŸ
                    const savedRule = await response.json();
                    rule.id = savedRule.id;
                    showToast('ãƒ«ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                } else {
                    throw new Error('APIä¿å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('APIä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                // APIå¤±æ•—æ™‚ã¯localStorageã«ä¿å­˜
                console.log('LocalStorageã«ä¿å­˜ã—ã¾ã™');
                showToast('ãƒ«ãƒ¼ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ', 'warning');
            }
            
            // ã„ãšã‚Œã®å ´åˆã‚‚ç”»é¢ã«è¿½åŠ 
            savedRules.push(rule);
            saveToLocalStorage();
            renderCards();
            resetForm();
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            document.getElementById('ruleName').value = '';
            document.getElementById('startTime').value = '18:00';
            document.getElementById('endTime').value = '21:00';
            document.getElementById('maxGroups').value = '10';
            document.getElementById('maxPeople').value = '40';
            document.getElementById('maxPerGroup').value = '8';
            document.getElementById('limitPerGroup').checked = false;
            // applyToWeekdaysã¯å­˜åœ¨ã—ãªã„ã®ã§å‰Šé™¤
            document.getElementById('maxPerGroup').disabled = true;
            updateTimeDisplay();
        }

        // ä¿å­˜æ¸ˆã¿ãƒ«ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
        async function loadSavedRules() {
            try {
                const response = await fetch(`${API_BASE}/capacity-control/rules?store_id=${STORE_ID}`);
                if (response.ok) {
                    savedRules = await response.json();
                } else {
                    throw new Error('APIèª­ã¿è¾¼ã¿å¤±æ•—');
                }
            } catch (error) {
                console.error('APIèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // APIå¤±æ•—æ™‚ã¯localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
                loadFromLocalStorage();
            }
            renderCards();
        }

        // LocalStorageä¿å­˜
        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(savedRules));
            } catch (error) {
                console.error('LocalStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // LocalStorageèª­ã¿è¾¼ã¿ï¼ˆè‡ªå‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ä»˜ãï¼‰
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const raw = JSON.parse(stored);
                    console.log('[Auto Migration] æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ•°:', raw.length);
                    
                    // dateModeãŒæœªå®šç¾©ã®ãƒ«ãƒ¼ãƒ«ã‚’ä¿®æ­£ã—ã€æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã‚‚æ­£è¦åŒ–
                    const migrated = raw.map(rule => {
                        if (!rule.dateMode) {
                            if (rule.date) {
                                rule.dateMode = 'single';
                            } else if (rule.startDate && rule.endDate) {
                                rule.dateMode = 'range';
                            } else if (rule.weekday !== undefined && rule.weekday !== null) {
                                rule.dateMode = 'weekly';
                            } else {
                                rule.dateMode = 'single';
                            }
                        }
                        // ensureRuleShapeã§æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’æ­£è¦åŒ–ï¼ˆresolveTimesçµŒç”±ï¼‰
                        return ensureRuleShape(rule);
                    });
                    
                    // â˜…é‡è¦ï¼šæ­£è¦åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å¿…ãšä¿å­˜ã—ç›´ã™ï¼ˆidempotent: é‡ã­ãŒã‘OKï¼‰
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
                    console.log('[Auto Migration] æ­£è¦åŒ–å®Œäº†:', migrated.length, 'ä»¶');
                    savedRules = migrated;
                    return migrated; // é…åˆ—ã‚’è¿”ã™
                } else {
                    savedRules = [];
                    return [];
                }
            } catch (error) {
                console.error('LocalStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                savedRules = [];
                return [];
            }
        }

        // ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆå¸¸ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ï¼‰
        function renderCards(rules) {
            const grid = document.getElementById('cardsGrid');
            const emptyState = document.getElementById('emptyState');
            
            // å¼•æ•°ãŒãªã„å ´åˆã¯æ¯å›LocalStorageã‹ã‚‰èª­ã¿ç›´ã™
            const src = Array.isArray(rules) ? rules : loadFromLocalStorage();
            const safe = Array.isArray(src) ? src.map(rule => ensureRuleShape(rule)) : [];
            
            // æ•´å½¢æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆä»»æ„ï¼‰
            localStorage.setItem(STORAGE_KEY, JSON.stringify(safe));
            
            if (safe.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            // æœ€æ–°ã®æ•´å½¢æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã§æç”»
            grid.innerHTML = safe.map(rule => createRuleCard(rule)).join('');
        }

        // ãƒ«ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ä½œæˆ
        function createRuleCard(rule) {
            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆè©³ç´°ç‰ˆï¼‰
            const shown = formatTimeRange(rule);
            console.debug("[createRuleCard] id:", rule?.id, {
                start: rule?.startTime, 
                end: rule?.endTime, 
                dateMode: rule?.dateMode,
                allDay: rule?.allDay,
                shown: shown || '(ç©ºæ–‡å­—)'
            });
            
            const today = new Date().toISOString().split('T')[0];
            
            // æ—¥ä»˜è¡¨ç¤ºã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®šã‚’ä¿®æ­£
            let dateDisplay = '';
            let status = 'upcoming';
            
            // dateMode ãŒæœªå®šç¾©ã®å ´åˆã€æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¨æ¸¬
            if (!rule.dateMode) {
                if (rule.date) {
                    rule.dateMode = 'single';
                } else if (rule.startDate && rule.endDate) {
                    rule.dateMode = 'range';
                } else if (rule.weekday !== undefined && rule.weekday !== null) {
                    rule.dateMode = 'weekly';
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                    rule.dateMode = 'single';
                    dateDisplay = 'æœªè¨­å®š';
                }
            }
            
            if (rule.dateMode === 'single' && rule.date) {
                dateDisplay = formatDate(rule.date);
                status = rule.date < today ? 'past' : rule.date === today ? 'active' : 'upcoming';
            } else if (rule.dateMode === 'range' && rule.startDate && rule.endDate) {
                dateDisplay = `${formatDate(rule.startDate)} - ${formatDate(rule.endDate)}`;
                status = rule.endDate < today ? 'past' : rule.startDate <= today && today <= rule.endDate ? 'active' : 'upcoming';
            } else if (rule.dateMode === 'weekly' && rule.weekday !== undefined && rule.weekday !== null) {
                const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                dateDisplay = `æ¯é€±${weekdays[rule.weekday]}æ›œæ—¥`;
                status = 'active'; // æ›œæ—¥æŒ‡å®šã¯å¸¸ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            }
            
            const statusText = status === 'past' ? 'çµ‚äº†' : status === 'active' ? 'æœ‰åŠ¹' : 'äºˆå®š';
            const statusClass = `status-${status}`;
            
            return `
                <div class="control-card">
                    <div class="card-status ${statusClass}">${statusText}</div>
                    <div class="card-date">${dateDisplay}</div>
                    <div class="card-time">
                        ${(() => {
                            const { s, e, isAllDay } = resolveTimes(rule);
                            if (s && e) return `â° ${s} - ${e}`;
                            if (isAllDay) return "â° çµ‚æ—¥";
                            return '<span style="opacity:.6">ï¼ˆæ™‚åˆ»ãªã—ï¼‰</span>';
                        })()}
                    </div>
                    <div class="card-limits">
                        ${rule.maxGroups ? `<div class="limit-item">
                            <span class="limit-label">çµ„æ•°åˆ¶é™</span>
                            <span class="limit-value">${rule.maxGroups}çµ„ã¾ã§</span>
                        </div>` : ''}
                        ${rule.maxPeople ? `<div class="limit-item">
                            <span class="limit-label">äººæ•°åˆ¶é™</span>
                            <span class="limit-value">${rule.maxPeople}äººã¾ã§</span>
                        </div>` : ''}
                        ${rule.maxPerGroup ? `<div class="limit-item">
                            <span class="limit-label">1çµ„ã‚ãŸã‚Š</span>
                            <span class="limit-value">æœ€å¤§${rule.maxPerGroup}äºº</span>
                        </div>` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="card-btn edit" onclick="editRule('${rule.id}')">ç·¨é›†</button>
                        <button class="card-btn delete" onclick="deleteRule('${rule.id}')">å‰Šé™¤</button>
                    </div>
                </div>
            `;
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateStr) {
            if (!dateStr) return 'æœªè¨­å®š';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return 'æœªè¨­å®š';
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥(${days[date.getDay()]})`;
        }

        // ã‚«ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterCards(filter) {
            const today = new Date().toISOString().split('T')[0];
            let filtered = savedRules;
            
            if (filter === 'active') {
                filtered = savedRules.filter(r => r.date === today);
            } else if (filter === 'upcoming') {
                filtered = savedRules.filter(r => r.date > today);
            } else if (filter === 'past') {
                filtered = savedRules.filter(r => r.date < today);
            }
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®è¡¨ç¤ºæ›´æ–°
            const grid = document.getElementById('cardsGrid');
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-text">è©²å½“ã™ã‚‹ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
            } else {
                grid.innerHTML = filtered.map(rule => createRuleCard(rule)).join('');
            }
        }

        // ãƒ«ãƒ¼ãƒ«ç·¨é›†
        function editRule(id) {
            const rule = savedRules.find(r => r.id == id);
            if (!rule) return;
            
            // ã¾ãšæ—¥ä»˜ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
            currentDateMode = rule.dateMode || 'single';
            document.querySelectorAll('[data-mode]').forEach(m => m.classList.remove('active'));
            const modeElement = document.querySelector(`[data-mode="${currentDateMode}"]`);
            if (modeElement) {
                modeElement.classList.add('active');
            }
            updateDateInputs();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            if (rule.dateMode === 'single' && rule.date) {
                document.getElementById('targetDate').value = rule.date;
            } else if (rule.dateMode === 'range') {
                document.getElementById('startDate').value = rule.startDate || '';
                document.getElementById('endDate').value = rule.endDate || '';
            } else if (rule.dateMode === 'weekly') {
                document.getElementById('targetWeekday').value = rule.weekday || 0;
            }
            
            document.getElementById('ruleName').value = rule.name || '';
            // æ™‚åˆ»ã‚’æ­£è¦åŒ–ã—ã¦è¡¨ç¤º
            const normalizedStart = normalizeHHMM(rule.startTime) || '18:00';
            const normalizedEnd = normalizeHHMM(rule.endTime) || '21:00';
            document.getElementById('startTime').value = normalizedStart;
            document.getElementById('endTime').value = normalizedEnd;
            
            // åˆ¶å¾¡ã‚¿ã‚¤ãƒ—ã‚’è¨­å®š
            document.querySelectorAll('.control-type[data-type]').forEach(t => {
                if (t.classList) t.classList.remove('active');
            });
            const typeElement = document.querySelector(`.control-type[data-type="${rule.controlType}"]`);
            if (typeElement && typeElement.classList) {
                typeElement.classList.add('active');
            }
            currentControlType = rule.controlType || 'groups';
            updateLimitInputs();
            
            if (rule.maxGroups) document.getElementById('maxGroups').value = rule.maxGroups;
            if (rule.maxPeople) document.getElementById('maxPeople').value = rule.maxPeople;
            if (rule.maxPerGroup) {
                document.getElementById('limitPerGroup').checked = true;
                document.getElementById('maxPerGroup').disabled = false;
                document.getElementById('maxPerGroup').value = rule.maxPerGroup;
            }
            
            updateTimeDisplay();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ãƒ«ãƒ¼ãƒ«å‰Šé™¤
        async function deleteRule(id) {
            if (!confirm('ã“ã®ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/capacity-control/rules/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // APIå‰Šé™¤æˆåŠŸ
                    showToast('ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                } else {
                    // APIå‰Šé™¤å¤±æ•—æ™‚ã‚‚localStorageã‹ã‚‰å‰Šé™¤
                    console.log('APIå‰Šé™¤å¤±æ•—ã€LocalStorageã‹ã‚‰å‰Šé™¤');
                    showToast('ãƒ«ãƒ¼ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ', 'warning');
                }
            } catch (error) {
                console.error('APIå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showToast('ãƒ«ãƒ¼ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ', 'warning');
            }
            
            // ã„ãšã‚Œã®å ´åˆã‚‚ç”»é¢ã‹ã‚‰å‰Šé™¤
            savedRules = savedRules.filter(r => r.id != id);
            saveToLocalStorage();
            renderCards();
        }

        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'âš ï¸'}
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 24æ™‚é–“è¡¨è¨˜å¼·åˆ¶é–¢æ•°
        function force24HourFormat() {
            const timeInputs = document.querySelectorAll('input[type="time"]');
            timeInputs.forEach(input => {
                // HTMLå±æ€§ã§24æ™‚é–“è¡¨è¨˜ã‚’è¨­å®š
                input.setAttribute('data-format', '24');
                input.step = '60'; // 1åˆ†åˆ»ã¿
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§å€¤ã‚’24æ™‚é–“å½¢å¼ã«å¤‰æ›
                input.addEventListener('change', function() {
                    const value = this.value;
                    if (value && !value.includes(':')) {
                        // 12æ™‚é–“å½¢å¼ã®å ´åˆã®å¤‰æ›å‡¦ç†
                        this.value = convertTo24Hour(value);
                    }
                });
                
                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«AM/PMãƒ”ãƒƒã‚«ãƒ¼ã‚’ç„¡åŠ¹åŒ–
                input.addEventListener('focus', function() {
                    setTimeout(() => {
                        const ampmFields = document.querySelectorAll('[class*="ampm"], [class*="meridiem"]');
                        ampmFields.forEach(field => {
                            field.style.display = 'none';
                            field.style.visibility = 'hidden';
                        });
                    }, 10);
                });
            });
        }

        function convertTo24Hour(time12h) {
            if (!time12h || time12h.includes(':')) return time12h;
            
            const [time, modifier] = time12h.split(' ');
            let [hours, minutes] = time.split(':');
            
            if (hours === '12') {
                hours = '00';
            }
            
            if (modifier === 'PM' || modifier === 'pm') {
                hours = parseInt(hours, 10) + 12;
            }
            
            return `${hours}:${minutes}`;
        }

        // æ™‚é–“æ­£è¦åŒ–ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        // æ™‚åˆ»ã®æ­£è¦åŒ–é–¢æ•°ï¼ˆä½•ãŒæ¥ã¦ã‚‚HH:mmå½¢å¼ã«å¤‰æ›ï¼‰
        function normalizeHHMMAny(v) {
            if (v == null || v === "") return "";

            // æ•°å€¤: åˆ†å˜ä½ or æ™‚ã®ã¿
            if (typeof v === "number" && Number.isFinite(v)) {
                if (v <= 24 && Number.isInteger(v)) return String(v).padStart(2, "0") + ":00"; // 9 â†’ 09:00
                const h = Math.floor(v / 60), m = v % 60;                                     // 540 â†’ 09:00
                return String(h).padStart(2, "0") + ":" + String(m).padStart(2, "0");
            }

            let s = String(v).trim();

            // å…¨è§’ã‚³ãƒ­ãƒ³/ä¸­ç‚¹/ãƒ€ãƒƒã‚·ãƒ¥ãªã©ã‚’å¸å
            s = s.replace(/[ï¼š]/g, ":").replace(/[ï¼ã€‚]/g, ".").replace(/[ï½°ãƒ¼â€\-]/g, ":");

            // HH:mm / H:mm / HH.mm / H.mm
            let m = s.match(/^(\d{1,2})[:\.](\d{1,2})$/);
            if (m) {
                const h = Math.min(23, Math.max(0, +m[1]));
                const mm = Math.min(59, Math.max(0, +m[2]));
                return String(h).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
            }

            // 9æ™‚30åˆ† / 9æ™‚ / 9æ™‚åŠ
            m = s.match(/^(\d{1,2})æ™‚(?:(\d{1,2})åˆ†?)?$/);
            if (m) {
                const h = Math.min(23, Math.max(0, +m[1]));
                const mm = m[2] ? Math.min(59, Math.max(0, +m[2])) : 0;
                return String(h).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
            }
            m = s.match(/^(\d{1,2})æ™‚åŠ$/);
            if (m) return String(+m[1]).padStart(2, "0") + ":30";

            // 0900 / 900 â†’ 09:00
            if (/^\d{3,4}$/.test(s)) {
                const hm = s.padStart(4, "0");
                const h = +hm.slice(0, 2), mm = +hm.slice(2);
                if (h <= 23 && mm <= 59) return hm.slice(0, 2) + ":" + hm.slice(2);
            }

            // HH / H â†’ HH:00
            if (/^\d{1,2}$/.test(s)) return s.padStart(2, "0") + ":00";

            // æ—¢ã« HH:mm
            if (/^\d{2}:\d{2}$/.test(s)) return s;

            return "";
        }
        
        // æ—§é–¢æ•°åã‚’ç¶­æŒï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
        function normalizeHHMM(v) {
            return normalizeHHMMAny(v);
        }

        // ã©ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ã‚‚æ‹¾ã†æ™‚åˆ»ãƒªã‚¾ãƒ«ãƒ
        function pickTimeFrom(rule, keys) {
            for (const k of keys) {
                const v = k.split(".").reduce((o, p) => (o ? o[p] : undefined), rule);
                const t = normalizeHHMMAny(v);
                if (t) return t;
            }
            return "";
        }

        function resolveTimes(rule) {
            const startKeys = [
                "startTime","start","from","time.start","timeStart",
                "start_minutes","startMinute","startMin","start_time_minutes",
                "startAt","start_at","begin","beginTime"
            ];
            const endKeys = [
                "endTime","end","to","time.end","timeEnd",
                "end_minutes","endMinute","endMin","end_time_minutes",
                "endAt","end_at","finish","finishTime"
            ];
            const s = pickTimeFrom(rule, startKeys);
            const e = pickTimeFrom(rule, endKeys);
            const isAllDay = rule?.dateMode === "allday" || rule?.allDay === true;
            return { s, e, isAllDay };
        }
        
        // æ—§é–¢æ•°ã‚’ç¶­æŒï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
        function coalesceTime(...cands) {
            for (const c of cands) {
                const hhmm = normalizeHHMM(c);
                if (hhmm) return hhmm;
            }
            return "";
        }

        // è¡¨ç¤ºç”¨é–¢æ•°ã‚’çµ±ä¸€
        function formatTimeRange(rule) {
            const { s, e, isAllDay } = resolveTimes(rule);
            if (s && e) return `â° ${s} - ${e}`;
            if (isAllDay) return "â° çµ‚æ—¥";
            return "";
        }

        // ãƒ«ãƒ¼ãƒ«ã®å½¢çŠ¶ã‚’ä¿è¨¼ã™ã‚‹é–¢æ•°ï¼ˆresolveTimesä½¿ç”¨ï¼‰
        function ensureRuleShape(rule) {
            const r = { ...rule };
            const { s, e, isAllDay } = resolveTimes(r);
            
            if (s && e) { 
                r.startTime = s; 
                r.endTime = e; 
            } else if (isAllDay) { 
                r.startTime = "00:00"; 
                r.endTime = "23:59"; 
            } else { 
                r.startTime = s || ""; 
                r.endTime = e || ""; 
            }
            
            // åˆ¶å¾¡ã‚¿ã‚¤ãƒ—ãŒæœªå®šç¾©ã®å ´åˆã®ã¿ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            if (!r.controlType) {
                r.controlType = 'groups';
            }

            // ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
            r.schemaVersion = 3;
            
            return r;
        }
    </script>
</body>
</html>