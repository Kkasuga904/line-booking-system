<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE‰∫àÁ¥Ñ„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #06c755 0%, #05a548 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            background: linear-gradient(135deg, #06c755 0%, #05a548 100%);
            padding: 20px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 600;
        }
        
        .content {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .required {
            color: #e74c3c;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #06c755;
            box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.1);
        }
        
        .date-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .date-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .date-option:hover {
            border-color: #06c755;
            background: #f0fff4;
        }
        
        .date-option.selected {
            background: #06c755;
            color: white;
            border-color: #06c755;
        }
        
        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .time-slot {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            background: white;
        }
        
        .time-slot.disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .time-slot.slot-full {
            background: #f8f9fa !important;
            border-color: #dee2e6 !important;
            pointer-events: none;
        }
        
        .time-slot.slot-limited {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .time-slot:hover:not(.disabled) {
            border-color: #06c755;
            background: #f0fff4;
        }
        
        .time-slot.selected {
            background: #06c755;
            color: white;
            border-color: #06c755;
        }
        
        .time-slot.disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #06c755 0%, #05a548 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(6, 199, 85, 0.3);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #06c755;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }
        
        .success-message.show {
            display: block;
        }
        
        .error-message {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }
        
        .error-message.show {
            display: block;
        }
        
        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
            color: white;
            font-size: 14px;
        }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ ‰∫àÁ¥Ñ„Éï„Ç©„Éº„É†</h1>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
            </div>
        </div>
        
        <div class="content">
            <form id="reservationForm">
                <!-- „ÅäÂêçÂâç -->
                <div class="form-group">
                    <label class="form-label">
                        „ÅäÂêçÂâç <span class="required">*</span>
                    </label>
                    <input type="text" class="form-control" id="customerName" required>
                </div>
                
                <!-- Êó•‰ªòÈÅ∏Êäû -->
                <div class="form-group">
                    <label class="form-label">
                        Êó•‰ªò <span class="required">*</span>
                    </label>
                    <div class="date-select" id="dateSelect">
                        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                    </div>
                    <input type="hidden" id="selectedDate">
                </div>
                
                <!-- ÊôÇÈñìÈÅ∏Êäû -->
                <div class="form-group">
                    <label class="form-label">
                        ÊôÇÈñì <span class="required">*</span>
                    </label>
                    <div class="time-slots" id="timeSlots">
                        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                    </div>
                    <input type="hidden" id="selectedTime">
                </div>
                
                <!-- ‰∫∫Êï∞ -->
                <div class="form-group">
                    <label class="form-label">
                        ‰∫∫Êï∞ <span class="required">*</span>
                    </label>
                    <select class="form-control" id="people" required>
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="1">1Âêç</option>
                        <option value="2">2Âêç</option>
                        <option value="3">3Âêç</option>
                        <option value="4">4Âêç</option>
                        <option value="5">5Âêç</option>
                        <option value="6">6Âêç</option>
                        <option value="7">7Âêç</option>
                        <option value="8">8Âêç</option>
                        <option value="9">9Âêç</option>
                        <option value="10">10Âêç</option>
                    </select>
                </div>
                
                <!-- ÈõªË©±Áï™Âè∑ -->
                <div class="form-group">
                    <label class="form-label">ÈõªË©±Áï™Âè∑</label>
                    <input type="tel" class="form-control" id="phone" placeholder="090-1234-5678">
                </div>
                
                <!-- „É°„ÉÉ„Çª„Éº„Ç∏ -->
                <div class="form-group">
                    <label class="form-label">„É°„ÉÉ„Çª„Éº„Ç∏</label>
                    <textarea class="form-control" id="message" rows="3" placeholder="„Ç¢„É¨„É´„ÇÆ„Éº„ÇÑË¶ÅÊúõ„Å™„Å©"></textarea>
                </div>
                
                <!-- ÈÄÅ‰ø°„Éú„Çø„É≥ -->
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    ‰∫àÁ¥Ñ„ÇíÁ¢∫ÂÆö„Åô„Çã
                </button>
            </form>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Âá¶ÁêÜ‰∏≠...</p>
            </div>
            
            <div class="success-message" id="successMessage">
                ‚úÖ ‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ
            </div>
            
            <div class="error-message" id="errorMessage">
                „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü
            </div>
        </div>
    </div>
    
    <script>
        let liffInitialized = false;
        let userProfile = null;
        
        // Êó•‰ªòÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàê
        function generateDates() {
            const dateSelect = document.getElementById('dateSelect');
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const dateOption = document.createElement('div');
                dateOption.className = 'date-option';
                dateOption.dataset.date = date.toISOString().split('T')[0];
                
                const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
                const dayName = dayNames[date.getDay()];
                
                dateOption.innerHTML = `
                    <div style="font-size: 12px; color: #666;">${date.getMonth() + 1}Êúà</div>
                    <div style="font-size: 18px; font-weight: bold;">${date.getDate()}</div>
                    <div style="font-size: 12px; color: #666;">${dayName}</div>
                `;
                
                dateOption.addEventListener('click', () => selectDate(dateOption));
                dateSelect.appendChild(dateOption);
            }
        }
        
        // Êó•‰ªòÈÅ∏Êäû
        function selectDate(element) {
            document.querySelectorAll('.date-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            document.getElementById('selectedDate').value = element.dataset.date;
            
            // ÊôÇÈñìÊû†„ÇíÂèñÂæó
            loadTimeSlots(element.dataset.date);
        }
        
        // ÊôÇÈñìÊû†„ÇíË™≠„ÅøËæº„ÅøÔºàÂÆπÈáè„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„ÅçÔºâ
        async function loadTimeSlots(date) {
            const timeSlotsDiv = document.getElementById('timeSlots');
            timeSlotsDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
            
            try {
                // ÂÆπÈáèÁä∂ÊÖã„ÇíÂèñÂæó
                const capacityResponse = await fetch(`/api/capacity-availability?date=${date}&store_id=${window.STORE_ID || 'default-store'}`);
                const capacityData = await capacityResponse.json();
                
                console.log('[LIFF] Capacity data received:', capacityData);
                
                timeSlotsDiv.innerHTML = '';
                
                // „Éá„Éï„Ç©„É´„Éà„ÅÆÊôÇÈñìÊû†
                const defaultTimes = ['11:00', '11:30', '12:00', '12:30', '13:00', '13:30', 
                              '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', 
                              '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', 
                              '20:00', '20:30'];
                
                const times = (slotsData.ok && slotsData.slots) ? 
                    slotsData.slots.map(s => s.time) : defaultTimes;
                
                times.forEach(time => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.dataset.time = time;
                    
                    // ÂÆπÈáèÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    let capacityStatus = null;
                    if (capacityData.ok && capacityData.slots) {
                        capacityStatus = capacityData.slots[time];
                        console.log(`[LIFF] Time ${time} capacity status:`, capacityStatus);
                    }
                    
                    // ÂÆπÈáè„Å´Âü∫„Å•„ÅÑ„Å¶„Çπ„Çø„Ç§„É´„ÇíË®≠ÂÆö
                    if (capacityStatus) {
                        if (capacityStatus.status === 'full') {
                            timeSlot.classList.add('disabled', 'slot-full');
                            timeSlot.innerHTML = `${time}<br><small style="color: #dc3545;">Ê∫ÄÂ∏≠</small>`;
                            timeSlot.style.backgroundColor = '#f8f9fa';
                            timeSlot.style.color = '#6c757d';
                            timeSlot.style.cursor = 'not-allowed';
                            timeSlot.style.opacity = '0.6';
                        } else if (capacityStatus.status === 'limited') {
                            timeSlot.classList.add('slot-limited');
                            timeSlot.innerHTML = `${time}<br><small style="color: #ffc107;">üî∂ ÊÆã„Çä${capacityStatus.available}ÁµÑ</small>`;
                            timeSlot.style.backgroundColor = '#fff3cd';
                            timeSlot.style.borderColor = '#ffc107';
                            timeSlot.addEventListener('click', () => selectTime(timeSlot));
                        } else if (capacityStatus.status === 'available') {
                            timeSlot.innerHTML = `${time}<br><small style="color: #28a745;">‚óã Á©∫Â∏≠„ÅÇ„Çä</small>`;
                            timeSlot.style.backgroundColor = '#d4edda';
                            timeSlot.style.borderColor = '#28a745';
                            timeSlot.addEventListener('click', () => selectTime(timeSlot));
                        } else {
                            timeSlot.textContent = time;
                            timeSlot.addEventListener('click', () => selectTime(timeSlot));
                        }
                    } else {
                        // API„Åã„Çâ„ÅÆÂøúÁ≠î„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÂ∏∏Ë°®Á§∫
                        timeSlot.textContent = time;
                        timeSlot.addEventListener('click', () => selectTime(timeSlot));
                    }
                    
                    timeSlotsDiv.appendChild(timeSlot);
                });
                }
            } catch (error) {
                console.error('Failed to load time slots:', error);
                // „Ç®„É©„ÉºÊôÇ„ÅØ„Éá„Éï„Ç©„É´„ÉàË°®Á§∫
                const times = ['11:00', '11:30', '12:00', '12:30', '13:00', '13:30', 
                              '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', 
                              '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', 
                              '20:00', '20:30'];
                
                timeSlotsDiv.innerHTML = '';
                times.forEach(time => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.dataset.time = time;
                    timeSlot.textContent = time;
                    timeSlot.addEventListener('click', () => selectTime(timeSlot));
                    timeSlotsDiv.appendChild(timeSlot);
                });
            }
        }
        
        // ÊôÇÈñìÈÅ∏Êäû
        function selectTime(element) {
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            element.classList.add('selected');
            document.getElementById('selectedTime').value = element.dataset.time;
        }
        
        // LIFFÂàùÊúüÂåñ
        async function initializeLiff() {
            try {
                await liff.init({ 
                    liffId: '2006487876-Xd1A5qJB'  // Â§ßÊñáÂ≠ó„ÅÆX„Å´‰øÆÊ≠£
                });
                
                liffInitialized = true;
                
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    userProfile = profile;
                    
                    // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
                    document.getElementById('userInfo').style.display = 'block';
                    document.getElementById('userName').textContent = `„Åì„Çì„Å´„Å°„ÅØ„ÄÅ${profile.displayName}„Åï„Çì`;
                    document.getElementById('customerName').value = profile.displayName;
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
            }
        }
        
        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        document.getElementById('reservationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const date = document.getElementById('selectedDate').value;
            const time = document.getElementById('selectedTime').value;
            const customerName = document.getElementById('customerName').value;
            const people = document.getElementById('people').value;
            const phone = document.getElementById('phone').value;
            const message = document.getElementById('message').value;
            
            if (!date || !time || !customerName || !people) {
                alert('ÂøÖÈ†àÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            document.getElementById('loading').classList.add('show');
            document.getElementById('submitBtn').disabled = true;
            
            try {
                const response = await fetch('/api/reservation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date,
                        time,
                        customer_name: customerName,
                        people,
                        phone,
                        message
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('successMessage').classList.add('show');
                    
                    // LINE„Ç¢„Éó„É™„Å´Êàª„Çã
                    setTimeout(() => {
                        if (liffInitialized && liff.isInClient()) {
                            liff.closeWindow();
                        }
                    }, 2000);
                } else {
                    throw new Error(result.error || '‰∫àÁ¥Ñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('Reservation error:', error);
                document.getElementById('loading').classList.remove('show');
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorMessage').classList.add('show');
                document.getElementById('submitBtn').disabled = false;
            }
        });
        
        // ÂàùÊúüÂåñ
        window.addEventListener('DOMContentLoaded', () => {
            generateDates();
            initializeLiff();
        });
    </script>
</body>
</html>