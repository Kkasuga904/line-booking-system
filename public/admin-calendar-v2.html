<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„ç®¡ç†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ | LINEäºˆç´„ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .store-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .store-name {
            font-size: 18px;
            font-weight: 600;
        }
        
        .view-controls {
            display: flex;
            gap: 10px;
        }
        
        .view-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .calendar-nav {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .nav-arrow {
            width: 36px;
            height: 36px;
            border: 1px solid #e0e0e0;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .nav-arrow:hover {
            background: #f5f5f7;
        }
        
        .current-month {
            font-size: 24px;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }
        
        .today-btn {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ */
        .view-toggle {
            display: flex;
            gap: 5px;
            background: #f0f0f0;
            padding: 3px;
            border-radius: 8px;
        }
        
        .view-btn {
            padding: 6px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #666;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .view-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .view-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* çµ±è¨ˆã‚µãƒãƒªãƒ¼ */
        .summary-bar {
            background: white;
            padding: 15px 20px;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .summary-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« */
        .calendar-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 20px;
        }
        
        .calendar-table-wrapper {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .calendar-table thead {
            background: #f8f9fa;
        }
        
        .calendar-table th {
            padding: 15px 10px;
            border: 1px solid #e0e0e0;
            text-align: center;
            font-weight: 600;
        }
        
        .calendar-table th:first-child {
            width: 80px;
            background: #f8f9fa;
        }
        
        .day-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .day-date {
            font-size: 20px;
            font-weight: 600;
        }
        
        th.today {
            background: #667eea;
            color: white;
        }
        
        th.today .day-header {
            color: rgba(255,255,255,0.9);
        }
        
        .calendar-table tbody td {
            border: 1px solid #e0e0e0;
            height: 60px;
            position: relative;
            vertical-align: top;
            padding: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .calendar-table tbody td:hover:not(:first-child) {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .calendar-table tbody td:first-child {
            background: #fafafa;
            text-align: center;
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }
        
        /* äºˆç´„ã‚«ãƒ¼ãƒ‰ */
        .reservation-card {
            position: relative;
            padding: 6px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            z-index: 5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reservation-card:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 15;
        }
        
        /* åŒæ™‚åˆ»ã®äºˆç´„ã‚³ãƒ³ãƒ†ãƒŠ */
        .time-slot-reservations {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 2px;
            min-height: 56px;
        }
        
        /* äºˆç´„ãŒå¤šã„å ´åˆã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .more-reservations {
            background: #666;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
        }
        
        .reservation-card.pending {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .reservation-card.confirmed {
            background: linear-gradient(135deg, #06c755, #00b74a);
            color: white;
        }
        
        .reservation-card.cancelled {
            background: linear-gradient(135deg, #ef5350, #e91e63);
            color: white;
            opacity: 0.7;
        }
        
        .card-content {
            flex: 1;
        }
        
        .card-time {
            font-weight: 600;
            font-size: 10px;
        }
        
        .card-name {
            font-size: 10px;
            margin-top: 1px;
        }
        
        .card-people {
            font-size: 9px;
            opacity: 0.9;
        }
        
        .card-seat {
            font-size: 10px;
            color: #fff;
            font-weight: 500;
            margin-top: 2px;
            opacity: 0.95;
        }
        
        .mobile-reservation-seat {
            font-size: 11px;
            color: #667eea;
            font-weight: 500;
            margin-top: 3px;
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼èª¿æ•´ */
        .calendar-scroll-wrapper {
            max-height: 600px;
            overflow: auto;
            position: relative;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-label {
            flex: 0 0 100px;
            color: #666;
            font-size: 14px;
        }
        
        .detail-value {
            flex: 1;
            font-size: 14px;
        }
        
        .modal-close {
            margin-top: 20px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
        }
        
        .modal-delete {
            margin-top: 10px;
            padding: 10px 20px;
            background: #ef5350;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
        }
        
        .modal-delete:hover {
            background: #e53935;
        }
        
        /* äºˆç´„è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .form-submit {
            margin-top: 20px;
            padding: 12px 24px;
            background: #06c755;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            font-weight: 500;
        }
        
        .form-submit:hover {
            background: #00b74a;
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³èª¿æ•´ */
            .calendar-nav {
                margin: 10px;
                padding: 15px;
            }
            
            .current-month {
                font-size: 18px;
                min-width: auto;
            }
            
            .summary-bar {
                margin: 10px;
                padding: 10px;
            }
            
            .summary-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .summary-value {
                font-size: 18px;
            }
            
            /* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã‚’ãƒªã‚¹ãƒˆå½¢å¼ã«å¤‰æ›´ */
            .calendar-table-wrapper {
                display: none;
            }
            
            /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ */
            .mobile-calendar-view {
                display: block;
                background: white;
                border-radius: 12px;
                padding: 10px;
                margin: 10px;
            }
            
            .mobile-day-section {
                margin-bottom: 20px;
                border-bottom: 1px solid #e0e0e0;
                padding-bottom: 15px;
            }
            
            .mobile-day-header {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 10px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 8px;
            }
            
            .mobile-day-header.today {
                background: #667eea;
                color: white;
            }
            
            .mobile-reservation-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            
            .mobile-reservation-card.pending {
                border-left: 4px solid #667eea;
            }
            
            .mobile-reservation-card.confirmed {
                border-left: 4px solid #06c755;
            }
            
            .mobile-reservation-card.cancelled {
                border-left: 4px solid #ef5350;
                opacity: 0.7;
            }
            
            .mobile-reservation-time {
                font-size: 16px;
                font-weight: 600;
                color: #1d1d1f;
                margin-bottom: 4px;
            }
            
            .mobile-reservation-name {
                font-size: 14px;
                color: #333;
                margin-bottom: 2px;
            }
            
            .mobile-reservation-people {
                font-size: 12px;
                color: #666;
            }
            
            .mobile-empty-message {
                text-align: center;
                color: #999;
                padding: 20px;
                font-size: 14px;
            }
        }
        
        /* PCã§ãƒ¢ãƒã‚¤ãƒ«ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º */
        @media (min-width: 769px) {
            .mobile-calendar-view {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="header-content">
            <div class="store-info">
                <span class="store-name">äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </span>
                <span style="color: #666; font-size: 14px;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼</span>
            </div>
            <div class="view-controls">
                <button class="view-btn" onclick="window.location.href='/admin'">ğŸ“‹ ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
                <button class="view-btn" onclick="window.location.href='/seats'">ğŸª‘ å¸­ç®¡ç†</button>
                <button class="view-btn" onclick="showSettingsModal()">âš™ï¸ è¨­å®š</button>
            </div>
        </div>
    </header>
    
    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="calendar-nav">
        <div class="nav-content">
            <div class="view-toggle">
                <button class="view-btn active" id="weekViewBtn" onclick="setViewMode('week')">é€±</button>
                <button class="view-btn" id="dayViewBtn" onclick="setViewMode('day')">æ—¥</button>
            </div>
            <div class="month-selector">
                <button class="nav-arrow" onclick="navigate(-1)">â†</button>
                <div class="current-month" id="currentPeriod">èª­ã¿è¾¼ã¿ä¸­...</div>
                <button class="nav-arrow" onclick="navigate(1)">â†’</button>
            </div>
            <button class="today-btn" onclick="goToToday()">ä»Šæ—¥</button>
        </div>
    </div>
    
    <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <div class="summary-bar">
        <div class="summary-content">
            <div class="summary-item">
                <div class="summary-label">æœ¬æ—¥ã®äºˆç´„</div>
                <div class="summary-value" id="todayCount">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">ä»Šé€±ã®äºˆç´„</div>
                <div class="summary-value" id="weekCount">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">äºˆç´„ç‡</div>
                <div class="summary-value" id="occupancyRate">0%</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">å¹³å‡äººæ•°</div>
                <div class="summary-value" id="avgPeople">0å</div>
            </div>
        </div>
    </div>
    
    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆPCç”¨ï¼‰ -->
    <div class="calendar-container">
        <div class="calendar-table-wrapper">
            <div class="calendar-scroll-wrapper">
                <table class="calendar-table">
                    <thead id="calendarHeader">
                        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã¯å‹•çš„ç”Ÿæˆ -->
                    </thead>
                    <tbody id="calendarBody">
                        <!-- ãƒœãƒ‡ã‚£ã¯å‹•çš„ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ -->
        <div class="mobile-calendar-view" id="mobileCalendarView">
            <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å‹•çš„ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">äºˆç´„è©³ç´°</div>
            <div id="modalDetails">
                <!-- è©³ç´°ã¯å‹•çš„ç”Ÿæˆ -->
            </div>
            <button class="modal-delete" id="modalDeleteBtn" onclick="deleteCurrentReservation()">ğŸ—‘ï¸ ã“ã®äºˆç´„ã‚’å‰Šé™¤</button>
            <button class="modal-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    
    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h2 class="modal-title">âš™ï¸ ç®¡ç†è¨­å®š</h2>
            
            <div style="margin-bottom: 25px;">
                <h3 style="font-size: 16px; margin-bottom: 15px; color: #667eea;">ğŸ“ åŸºæœ¬è¨­å®š</h3>
                <div class="form-group">
                    <label class="form-label">åº—èˆ—å</label>
                    <input type="text" class="form-input" id="settingStoreName" placeholder="ä¾‹: ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã€‡ã€‡">
                </div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h3 style="font-size: 16px; margin-bottom: 15px; color: #667eea;">â° å–¶æ¥­æ™‚é–“</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">é–‹åº—æ™‚é–“</label>
                        <select class="form-input" id="settingOpenHour">
                            <option value="9">9:00</option>
                            <option value="10">10:00</option>
                            <option value="11">11:00</option>
                            <option value="12">12:00</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é–‰åº—æ™‚é–“</label>
                        <select class="form-input" id="settingCloseHour">
                            <option value="20">20:00</option>
                            <option value="21">21:00</option>
                            <option value="22">22:00</option>
                            <option value="23">23:00</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h3 style="font-size: 16px; margin-bottom: 15px; color: #667eea;">ğŸ“ äºˆç´„è¨­å®š</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">æœ€å°äººæ•°</label>
                        <input type="number" class="form-input" id="settingMinPeople" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æœ€å¤§äººæ•°</label>
                        <input type="number" class="form-input" id="settingMaxPeople" max="100" value="20">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">äºˆç´„å—ä»˜æœŸé–“</label>
                    <select class="form-input" id="settingBookingPeriod">
                        <option value="7">1é€±é–“å…ˆã¾ã§</option>
                        <option value="14">2é€±é–“å…ˆã¾ã§</option>
                        <option value="30">1ãƒ¶æœˆå…ˆã¾ã§</option>
                        <option value="60">2ãƒ¶æœˆå…ˆã¾ã§</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h3 style="font-size: 16px; margin-bottom: 15px; color: #667eea;">ğŸª‘ å¸­ç®¡ç†</h3>
                <button class="form-button" style="background: #06c755; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px;" onclick="window.location.href='/seats'">
                    å¸­ã®ç®¡ç†ç”»é¢ã¸
                </button>
                <span style="color: #999; font-size: 14px;">ç¾åœ¨ã®ç™»éŒ²å¸­æ•°: <span id="seatCount">0</span>å¸­</span>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h3 style="font-size: 16px; margin-bottom: 15px; color: #667eea;">ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
                <div class="form-group">
                    <label class="form-label">ç®¡ç†ç”»é¢ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" class="form-input" id="settingPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
                    <input type="password" class="form-input" id="settingPasswordConfirm" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›">
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                <button class="modal-close" onclick="closeSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="form-button" style="background: #667eea; color: white; padding: 10px 30px; border: none; border-radius: 8px; cursor: pointer;" onclick="saveSettings()">
                    è¨­å®šã‚’ä¿å­˜
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentWeekStart = new Date();
        let currentDate = new Date();
        let viewMode = 'week'; // 'week' or 'day'
        let allReservations = [];
        let currentReservation = null; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºä¸­ã®äºˆç´„
        let allSeats = []; // åˆ©ç”¨å¯èƒ½ãªå¸­ãƒªã‚¹ãƒˆ
        let settings = {}; // è¨­å®šãƒ‡ãƒ¼ã‚¿
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeCalendar();
            loadSeats();
            loadReservations();
            setInterval(loadReservations, 30000);
        });
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–
        function initializeCalendar() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            currentDate = new Date(today);
            
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() + diff);
            currentWeekStart.setHours(0, 0, 0, 0);
            
            renderCalendar();
        }
        
        // ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('weekViewBtn').classList.toggle('active', mode === 'week');
            document.getElementById('dayViewBtn').classList.toggle('active', mode === 'day');
            renderCalendar();
            displayReservations();
        }
        
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        function navigate(direction) {
            if (viewMode === 'week') {
                currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            } else {
                currentDate.setDate(currentDate.getDate() + direction);
                // é€±ã®é–‹å§‹ã‚‚æ›´æ–°
                const dayOfWeek = currentDate.getDay();
                const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                currentWeekStart = new Date(currentDate);
                currentWeekStart.setDate(currentDate.getDate() + diff);
                currentWeekStart.setHours(0, 0, 0, 0);
            }
            renderCalendar();
            displayReservations();
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderCalendar() {
            if (viewMode === 'week') {
                renderWeekView();
            } else {
                renderDayView();
            }
            renderMobileView();
            updatePeriodDisplay();
        }
        
        // é€±è¡¨ç¤º
        function renderWeekView() {
            renderHeader();
            renderBody();
        }
        
        // æ—¥è¡¨ç¤º
        function renderDayView() {
            const header = document.getElementById('calendarHeader');
            const body = document.getElementById('calendarBody');
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const dayOfWeek = currentDate.getDay();
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            header.innerHTML = `
                <tr>
                    <th>æ™‚é–“</th>
                    <th class="today" data-date="${dateStr}">
                        <div class="day-header">${days[dayOfWeek]}</div>
                        <div class="day-date">${currentDate.getDate()}</div>
                    </th>
                </tr>
            `;
            
            // ãƒœãƒ‡ã‚£
            let html = '';
            for (let hour = 10; hour <= 22; hour++) {
                html += `
                    <tr>
                        <td>${hour}:00</td>
                        <td data-date="${dateStr}" data-hour="${hour}" 
                            onclick="showAddReservationModal('${dateStr}', ${hour})"></td>
                    </tr>
                `;
            }
            body.innerHTML = html;
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼æç”»
        function renderHeader() {
            const header = document.getElementById('calendarHeader');
            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let html = '<tr><th>æ™‚é–“</th>';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + i);
                date.setHours(0, 0, 0, 0);
                
                const isToday = date.toDateString() === today.toDateString();
                const className = isToday ? 'today' : '';
                
                // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‚’ä½¿ç”¨ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ï¼‰
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                html += `<th class="${className}" data-date="${dateStr}">
                    <div class="day-header">${days[i]}</div>
                    <div class="day-date">${date.getDate()}</div>
                </th>`;
            }
            
            html += '</tr>';
            header.innerHTML = html;
        }
        
        // ãƒœãƒ‡ã‚£æç”»
        function renderBody() {
            const body = document.getElementById('calendarBody');
            let html = '';
            
            // 10:00ã‹ã‚‰22:00ã¾ã§
            for (let hour = 10; hour <= 22; hour++) {
                html += '<tr>';
                html += `<td>${hour}:00</td>`;
                
                for (let day = 0; day < 7; day++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(currentWeekStart.getDate() + day);
                    date.setHours(0, 0, 0, 0);
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‚’ä½¿ç”¨ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ï¼‰
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const dayStr = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${dayStr}`;
                    
                    html += `<td data-date="${dateStr}" data-hour="${hour}" data-day="${day}" 
                                onclick="showAddReservationModal('${dateStr}', ${hour})"></td>`;
                }
                
                html += '</tr>';
            }
            
            body.innerHTML = html;
        }
        
        // æœŸé–“è¡¨ç¤ºæ›´æ–°
        function updatePeriodDisplay() {
            if (viewMode === 'week') {
                const endDate = new Date(currentWeekStart);
                endDate.setDate(currentWeekStart.getDate() + 6);
                
                const startStr = `${currentWeekStart.getFullYear()}å¹´${currentWeekStart.getMonth() + 1}æœˆ${currentWeekStart.getDate()}æ—¥`;
                const endStr = `${endDate.getMonth() + 1}æœˆ${endDate.getDate()}æ—¥`;
                
                document.getElementById('currentPeriod').textContent = `${startStr} - ${endStr}`;
            } else {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const date = currentDate.getDate();
                const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                const dayOfWeek = days[currentDate.getDay()];
                
                document.getElementById('currentPeriod').textContent = `${year}å¹´${month}æœˆ${date}æ—¥ (${dayOfWeek})`;
            }
        }
        
        // ä»Šæ—¥ã¸ç§»å‹•
        function goToToday() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            currentDate = new Date(today);
            
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() + diff);
            currentWeekStart.setHours(0, 0, 0, 0);
            
            renderCalendar();
            displayReservations();
        }
        
        // äºˆç´„ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadReservations() {
            try {
                const response = await fetch('/api/admin-supabase');
                const data = await response.json();
                
                if (data.reservations) {
                    allReservations = data.reservations;
                    displayReservations();
                    updateStatistics();
                }
            } catch (error) {
                console.error('Error loading reservations:', error);
            }
        }
        
        // ãƒ¢ãƒã‚¤ãƒ«ãƒ“ãƒ¥ãƒ¼æç”»
        function renderMobileView() {
            const mobileView = document.getElementById('mobileCalendarView');
            if (!mobileView) return;
            
            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let html = '';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + i);
                date.setHours(0, 0, 0, 0);
                
                // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‚’ä½¿ç”¨
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const dayStr = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${dayStr}`;
                
                const isToday = date.toDateString() === today.toDateString();
                
                html += `
                    <div class="mobile-day-section">
                        <div class="mobile-day-header ${isToday ? 'today' : ''}">
                            ${days[i]}æ›œæ—¥ ${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥
                        </div>
                        <div class="mobile-day-reservations" data-date="${dateStr}">
                            <!-- äºˆç´„ã¯å¾Œã§è¿½åŠ  -->
                        </div>
                    </div>
                `;
            }
            
            mobileView.innerHTML = html;
        }
        
        // äºˆç´„è¡¨ç¤º
        function displayReservations() {
            if (viewMode === 'week') {
                // PCç”¨è¡¨ç¤º
                displayPCReservations();
                // ãƒ¢ãƒã‚¤ãƒ«ç”¨è¡¨ç¤º
                displayMobileReservations();
            } else {
                // æ—¥è¡¨ç¤º
                displayDayReservations();
            }
        }
        
        // æ—¥è¡¨ç¤ºã®äºˆç´„è¡¨ç¤º
        function displayDayReservations() {
            // æ—¢å­˜ã®äºˆç´„ã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.time-slot-reservations').forEach(container => container.remove());
            document.querySelectorAll('.reservation-card').forEach(card => card.remove());
            
            // ç¾åœ¨ã®æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            // è©²å½“æ—¥ã®äºˆç´„ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const dayReservations = allReservations.filter(r => r.date === dateStr);
            
            // æ™‚é–“ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const reservationsByHour = {};
            dayReservations.forEach(reservation => {
                const hour = parseInt(reservation.time.split(':')[0]);
                if (!reservationsByHour[hour]) {
                    reservationsByHour[hour] = [];
                }
                reservationsByHour[hour].push(reservation);
            });
            
            // å„æ™‚é–“å¸¯ã«äºˆç´„ã‚’é…ç½®
            Object.entries(reservationsByHour).forEach(([hour, reservations]) => {
                const cell = document.querySelector(
                    `td[data-date="${dateStr}"][data-hour="${hour}"]`
                );
                
                if (cell) {
                    const container = document.createElement('div');
                    container.className = 'time-slot-reservations';
                    container.style.width = '100%';
                    
                    reservations.forEach(reservation => {
                        const timeParts = reservation.time.split(':');
                        const card = document.createElement('div');
                        card.className = `reservation-card ${reservation.status}`;
                        card.style.width = 'auto';
                        card.style.marginRight = '0';
                        
                        const seatInfo = reservation.seat_name ? 
                            `<div class="card-seat">ğŸ“${reservation.seat_name}</div>` : '';
                        
                        card.innerHTML = `
                            <div class="card-content">
                                <div class="card-time">${timeParts[0]}:${timeParts[1]}</div>
                                <div class="card-name">${reservation.customer_name || 'ã‚²ã‚¹ãƒˆ'}æ§˜</div>
                                <div class="card-people">${reservation.people}å</div>
                                ${seatInfo}
                                ${reservation.message ? `<div class="card-message" style="font-size: 10px; color: #999; margin-top: 3px;">${reservation.message}</div>` : ''}
                            </div>
                        `;
                        
                        card.onclick = () => showReservationDetail(reservation);
                        container.appendChild(card);
                    });
                    
                    cell.appendChild(container);
                }
            });
        }
        
        // PCç”¨äºˆç´„è¡¨ç¤º
        function displayPCReservations() {
            // æ—¢å­˜ã®äºˆç´„ã‚«ãƒ¼ãƒ‰ã¨ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.time-slot-reservations').forEach(container => container.remove());
            document.querySelectorAll('.reservation-card').forEach(card => card.remove());
            
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 7);
            
            // ä»Šé€±ã®äºˆç´„ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const weekReservations = allReservations.filter(r => {
                // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜æ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¦æ¯”è¼ƒ
                const startYear = currentWeekStart.getFullYear();
                const startMonth = String(currentWeekStart.getMonth() + 1).padStart(2, '0');
                const startDay = String(currentWeekStart.getDate()).padStart(2, '0');
                const startDateStr = `${startYear}-${startMonth}-${startDay}`;
                
                const endYear = weekEnd.getFullYear();
                const endMonth = String(weekEnd.getMonth() + 1).padStart(2, '0');
                const endDay = String(weekEnd.getDate()).padStart(2, '0');
                const endDateStr = `${endYear}-${endMonth}-${endDay}`;
                
                return r.date >= startDateStr && r.date < endDateStr;
            });
            
            // æ™‚é–“ã¨ã‚»ãƒ«ã”ã¨ã«äºˆç´„ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const reservationsByCell = {};
            weekReservations.forEach(reservation => {
                const hour = parseInt(reservation.time.split(':')[0]);
                const key = `${reservation.date}_${hour}`;
                if (!reservationsByCell[key]) {
                    reservationsByCell[key] = [];
                }
                reservationsByCell[key].push(reservation);
            });
            
            // å„ã‚»ãƒ«ã«äºˆç´„ã‚’é…ç½®
            Object.entries(reservationsByCell).forEach(([key, reservations]) => {
                const [date, hour] = key.split('_');
                const cell = document.querySelector(
                    `td[data-date="${date}"][data-hour="${hour}"]`
                );
                
                if (cell) {
                    // ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                    const container = document.createElement('div');
                    container.className = 'time-slot-reservations';
                    
                    // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
                    reservations.sort((a, b) => a.time.localeCompare(b.time));
                    
                    // æœ€å¤§3ä»¶ã¾ã§è¡¨ç¤ºã€ãã‚Œä»¥ä¸Šã¯ã€Œ+Nä»¶ã€è¡¨ç¤º
                    const maxDisplay = 3;
                    const displayReservations = reservations.slice(0, maxDisplay);
                    const remaining = reservations.length - maxDisplay;
                    
                    displayReservations.forEach(reservation => {
                        const timeParts = reservation.time.split(':');
                        const card = document.createElement('div');
                        card.className = `reservation-card ${reservation.status}`;
                        
                        // å¸­æƒ…å ±ã‚’å–å¾—
                        const seatInfo = reservation.seat_name ? 
                            `<div class="card-seat">ğŸ“${reservation.seat_name}</div>` : '';
                        
                        card.innerHTML = `
                            <div class="card-content">
                                <div class="card-time">${timeParts[0]}:${timeParts[1]}</div>
                                <div class="card-name">${reservation.customer_name || 'ã‚²ã‚¹ãƒˆ'}æ§˜</div>
                                <div class="card-people">${reservation.people}å</div>
                                ${seatInfo}
                            </div>
                        `;
                        
                        card.onclick = () => showReservationDetail(reservation);
                        container.appendChild(card);
                    });
                    
                    // æ®‹ã‚Šã®äºˆç´„ãŒã‚ã‚‹å ´åˆ
                    if (remaining > 0) {
                        const moreIndicator = document.createElement('div');
                        moreIndicator.className = 'more-reservations';
                        moreIndicator.textContent = `+${remaining}ä»¶`;
                        moreIndicator.onclick = () => {
                            // ã™ã¹ã¦ã®äºˆç´„ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                            showAllReservationsForSlot(reservations, date, hour);
                        };
                        container.appendChild(moreIndicator);
                    }
                    
                    cell.appendChild(container);
                }
            });
        }
        
        // ç‰¹å®šæ™‚é–“å¸¯ã®ã™ã¹ã¦ã®äºˆç´„ã‚’è¡¨ç¤º
        function showAllReservationsForSlot(reservations, date, hour) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title">${date} ${hour}:00ã®äºˆç´„ä¸€è¦§</div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${reservations.map(r => `
                            <div class="detail-row" style="cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; margin-bottom: 5px; border-radius: 4px;"
                                 onclick="showReservationDetail(${JSON.stringify(r).replace(/"/g, '&quot;')})">
                                <strong>${r.time.substring(0, 5)}</strong> - 
                                ${r.customer_name || 'ã‚²ã‚¹ãƒˆ'}æ§˜ (${r.people}å)
                            </div>
                        `).join('')}
                    </div>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">é–‰ã˜ã‚‹</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ãƒ¢ãƒã‚¤ãƒ«ç”¨äºˆç´„è¡¨ç¤º
        function displayMobileReservations() {
            const mobileView = document.getElementById('mobileCalendarView');
            if (!mobileView) return;
            
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 7);
            
            // ä»Šé€±ã®äºˆç´„ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const weekReservations = allReservations.filter(r => {
                // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜æ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¦æ¯”è¼ƒ
                const startYear = currentWeekStart.getFullYear();
                const startMonth = String(currentWeekStart.getMonth() + 1).padStart(2, '0');
                const startDay = String(currentWeekStart.getDate()).padStart(2, '0');
                const startDateStr = `${startYear}-${startMonth}-${startDay}`;
                
                const endYear = weekEnd.getFullYear();
                const endMonth = String(weekEnd.getMonth() + 1).padStart(2, '0');
                const endDay = String(weekEnd.getDate()).padStart(2, '0');
                const endDateStr = `${endYear}-${endMonth}-${endDay}`;
                
                return r.date >= startDateStr && r.date < endDateStr;
            });
            
            // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const reservationsByDate = {};
            weekReservations.forEach(r => {
                if (!reservationsByDate[r.date]) {
                    reservationsByDate[r.date] = [];
                }
                reservationsByDate[r.date].push(r);
            });
            
            // å„æ—¥ã®äºˆç´„ã‚’è¡¨ç¤º
            document.querySelectorAll('.mobile-day-reservations').forEach(container => {
                const date = container.dataset.date;
                const dayReservations = reservationsByDate[date] || [];
                
                if (dayReservations.length === 0) {
                    container.innerHTML = '<div class="mobile-empty-message">äºˆç´„ãªã—</div>';
                } else {
                    // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
                    dayReservations.sort((a, b) => a.time.localeCompare(b.time));
                    
                    container.innerHTML = dayReservations.map(r => {
                        const timeParts = r.time.split(':');
                        const seatInfo = r.seat_name ? 
                            `<div class="mobile-reservation-seat">ğŸ“${r.seat_name}</div>` : '';
                        return `
                            <div class="mobile-reservation-card ${r.status}" 
                                 onclick='showReservationDetail(${JSON.stringify(r).replace(/'/g, "&apos;")})'>
                                <div class="mobile-reservation-time">${timeParts[0]}:${timeParts[1]}</div>
                                <div class="mobile-reservation-name">${r.customer_name || 'ã‚²ã‚¹ãƒˆ'}æ§˜</div>
                                <div class="mobile-reservation-people">${r.people}å</div>
                                ${seatInfo}
                            </div>
                        `;
                    }).join('');
                }
            });
        }
        
        // äºˆç´„è©³ç´°è¡¨ç¤º
        function showReservationDetail(reservation) {
            currentReservation = reservation; // å‰Šé™¤ç”¨ã«ä¿å­˜
            
            const statusText = {
                'pending': 'äºˆç´„ç¢ºå®š',
                'confirmed': 'ç¢ºèªæ¸ˆã¿',
                'cancelled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
            };
            
            document.getElementById('modalTitle').textContent = 
                `${reservation.customer_name || 'ã‚²ã‚¹ãƒˆ'}æ§˜ã®ã”äºˆç´„`;
            
            document.getElementById('modalDetails').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">äºˆç´„ID</div>
                    <div class="detail-value">#${reservation.id}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æ—¥ä»˜</div>
                    <div class="detail-value">${reservation.date}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">æ™‚é–“</div>
                    <div class="detail-value">${reservation.time.substring(0, 5)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">äººæ•°</div>
                    <div class="detail-value">${reservation.people}å</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                    <div class="detail-value">${statusText[reservation.status] || reservation.status}</div>
                </div>
                ${reservation.seat_name ? `
                <div class="detail-row">
                    <div class="detail-label">å¸­</div>
                    <div class="detail-value">ğŸ“ ${reservation.seat_name}</div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">ä½œæˆæ—¥æ™‚</div>
                    <div class="detail-value">${new Date(reservation.created_at).toLocaleString('ja-JP')}</div>
                </div>
            `;
            
            document.getElementById('detailModal').classList.add('show');
        }
        
        // ç¾åœ¨ã®äºˆç´„ã‚’å‰Šé™¤
        async function deleteCurrentReservation() {
            if (!currentReservation) return;
            
            const confirmMessage = `äºˆç´„ID: #${currentReservation.id}\n${currentReservation.customer_name || 'ã‚²ã‚¹ãƒˆ'}æ§˜\n${currentReservation.date} ${currentReservation.time.substring(0, 5)}\n\nã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
            
            if (!confirm(confirmMessage)) return;
            
            try {
                const response = await fetch(`/api/admin-delete?id=${currentReservation.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    closeModal();
                    loadReservations(); // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                } else {
                    alert(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('detailModal').classList.remove('show');
            currentReservation = null;
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStatistics() {
            const today = new Date().toISOString().split('T')[0];
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 7);
            
            // æœ¬æ—¥ã®äºˆç´„
            const todayReservations = allReservations.filter(r => 
                r.date === today && r.status !== 'cancelled'
            );
            document.getElementById('todayCount').textContent = todayReservations.length;
            
            // ä»Šé€±ã®äºˆç´„
            const weekReservations = allReservations.filter(r => {
                const resDate = new Date(r.date);
                return resDate >= currentWeekStart && resDate < weekEnd && r.status !== 'cancelled';
            });
            document.getElementById('weekCount').textContent = weekReservations.length;
            
            // äºˆç´„ç‡
            const maxReservations = 7 * 50;
            const occupancy = Math.round((weekReservations.length / maxReservations) * 100);
            document.getElementById('occupancyRate').textContent = `${occupancy}%`;
            
            // å¹³å‡äººæ•°
            if (weekReservations.length > 0) {
                const totalPeople = weekReservations.reduce((sum, r) => sum + r.people, 0);
                const avgPeople = (totalPeople / weekReservations.length).toFixed(1);
                document.getElementById('avgPeople').textContent = `${avgPeople}å`;
            } else {
                document.getElementById('avgPeople').textContent = '0å';
            }
        }
        
        // å¸­ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadSeats() {
            try {
                const response = await fetch('/api/seats-manage');
                const data = await response.json();
                
                if (data.success) {
                    allSeats = data.seats || [];
                }
            } catch (error) {
                console.error('Error loading seats:', error);
            }
        }
        
        // äºˆç´„è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        async function showAddReservationModal(date, hour) {
            // æ—¢å­˜ã®äºˆç´„è©³ç´°ãŒã‚ã‚‹å ´åˆã¯ç„¡è¦–
            if (event.target.closest('.reservation-card') || event.target.closest('.more-reservations')) {
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'addReservationModal';
            
            const timeOptions = [];
            for (let min = 0; min < 60; min += 15) {
                const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                timeOptions.push(`<option value="${timeStr}">${timeStr}</option>`);
            }
            
            // å¸­ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
            const seatOptions = allSeats.length > 0 
                ? allSeats.map(seat => 
                    `<option value="${seat.id}">${seat.name} (${seat.capacity}å)</option>`
                  ).join('')
                : '<option value="">å¸­æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</option>';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-title">æ–°è¦äºˆç´„è¿½åŠ </div>
                    <form id="addReservationForm" onsubmit="submitNewReservation(event)">
                        <div class="form-group">
                            <label class="form-label">ãŠåå‰ <span style="color: red;">*</span></label>
                            <input type="text" class="form-input" name="customer_name" required 
                                   placeholder="å±±ç”°å¤ªéƒ">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æ—¥ä»˜ <span style="color: red;">*</span></label>
                                <input type="date" class="form-input" name="date" value="${date}" required
                                       onchange="checkSeatAvailability()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ™‚é–“ <span style="color: red;">*</span></label>
                                <select class="form-input" name="time" required onchange="checkSeatAvailability()">
                                    ${timeOptions.join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">äººæ•° <span style="color: red;">*</span></label>
                                <select class="form-input" name="people" required onchange="checkSeatAvailability()">
                                    ${Array.from({length: 20}, (_, i) => 
                                        `<option value="${i+1}">${i+1}å</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">å¸­ã‚’å‰²ã‚Šå½“ã¦</label>
                                <select class="form-input" name="seat_id" id="seatSelect">
                                    <option value="">è‡ªå‹•å‰²ã‚Šå½“ã¦</option>
                                    ${seatOptions}
                                </select>
                                <small id="seatAvailability" style="color: #666; font-size: 12px;"></small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">é›»è©±ç•ªå·</label>
                                <input type="tel" class="form-input" name="phone" 
                                       placeholder="090-1234-5678">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" class="form-input" name="email" 
                                       placeholder="example@example.com">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»è¦æœ›</label>
                            <textarea class="form-input" name="message" rows="3" 
                                      placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±ã‚„ç‰¹åˆ¥ãªè¦æœ›ãªã©"></textarea>
                        </div>
                        
                        <button type="submit" class="form-submit">âœ… äºˆç´„ã‚’è¿½åŠ </button>
                        <button type="button" class="modal-close" onclick="closeAddModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // åˆå›ã®å¸­ç©ºãçŠ¶æ³ãƒã‚§ãƒƒã‚¯
            setTimeout(checkSeatAvailability, 100);
        }
        
        // å¸­ã®ç©ºãçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
        async function checkSeatAvailability() {
            const form = document.getElementById('addReservationForm');
            if (!form) return;
            
            const date = form.date.value;
            const time = form.time.value;
            const people = form.people.value;
            
            if (!date || !time) return;
            
            try {
                const response = await fetch('/api/check-seat-availability', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ date, time, people })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const seatSelect = document.getElementById('seatSelect');
                    const availabilityText = document.getElementById('seatAvailability');
                    
                    // åˆ©ç”¨å¯èƒ½ãªå¸­ã‚’æ›´æ–°
                    seatSelect.innerHTML = '<option value="">è‡ªå‹•å‰²ã‚Šå½“ã¦</option>';
                    
                    if (data.availableSeats.length > 0) {
                        data.availableSeats.forEach(seat => {
                            const option = document.createElement('option');
                            option.value = seat.id;
                            option.textContent = `${seat.name} (${seat.capacity}å)`;
                            if (data.recommendedSeat && seat.id === data.recommendedSeat.id) {
                                option.textContent += ' â˜…ãŠã™ã™ã‚';
                                option.selected = true;
                            }
                            seatSelect.appendChild(option);
                        });
                        
                        availabilityText.textContent = `${data.availableSeats.length}å¸­åˆ©ç”¨å¯èƒ½`;
                        availabilityText.style.color = '#06c755';
                    } else {
                        availabilityText.textContent = 'ã“ã®æ™‚é–“å¸¯ã¯æº€å¸­ã§ã™';
                        availabilityText.style.color = '#ef5350';
                    }
                }
            } catch (error) {
                console.error('Check availability error:', error);
            }
        }
        
        // äºˆç´„è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeAddModal() {
            const modal = document.getElementById('addReservationModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // æ–°è¦äºˆç´„ã‚’é€ä¿¡
        async function submitNewReservation(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/admin-create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('äºˆç´„ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    closeAddModal();
                    loadReservations(); // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                } else {
                    alert(`è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }
            } catch (error) {
                console.error('Add error:', error);
                alert('è¿½åŠ å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            const addModal = document.getElementById('addReservationModal');
            
            if (event.target === detailModal) {
                closeModal();
            }
            if (event.target === addModal) {
                closeAddModal();
            }
        }
        
        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showSettingsModal() {
            loadSettings();
            document.getElementById('settingsModal').classList.add('show');
            // å¸­æ•°ã‚’æ›´æ–°
            document.getElementById('seatCount').textContent = allSeats.length;
        }
        
        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }
        
        // è¨­å®šèª­ã¿è¾¼ã¿
        function loadSettings() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
            const savedSettings = localStorage.getItem('adminSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                document.getElementById('settingStoreName').value = settings.storeName || 'ãƒ‡ãƒ¢ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³';
                document.getElementById('settingOpenHour').value = settings.openHour || '11';
                document.getElementById('settingCloseHour').value = settings.closeHour || '22';
                document.getElementById('settingMinPeople').value = settings.minPeople || '1';
                document.getElementById('settingMaxPeople').value = settings.maxPeople || '20';
                document.getElementById('settingBookingPeriod').value = settings.bookingPeriod || '30';
            }
        }
        
        // è¨­å®šä¿å­˜
        function saveSettings() {
            const password = document.getElementById('settingPassword').value;
            const passwordConfirm = document.getElementById('settingPasswordConfirm').value;
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
            if (password && password !== passwordConfirm) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                return;
            }
            
            // è¨­å®šã‚’åé›†
            settings = {
                storeName: document.getElementById('settingStoreName').value,
                openHour: document.getElementById('settingOpenHour').value,
                closeHour: document.getElementById('settingCloseHour').value,
                minPeople: document.getElementById('settingMinPeople').value,
                maxPeople: document.getElementById('settingMaxPeople').value,
                bookingPeriod: document.getElementById('settingBookingPeriod').value
            };
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°ä¿å­˜
            if (password) {
                settings.adminPassword = btoa(password); // ç°¡æ˜“çš„ãªã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
            }
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('adminSettings', JSON.stringify(settings));
            
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            closeSettingsModal();
            
            // åº—èˆ—åã‚’æ›´æ–°
            const storeNameElements = document.querySelectorAll('.store-name');
            storeNameElements.forEach(el => {
                if (settings.storeName) {
                    el.textContent = settings.storeName;
                }
            });
        }
    </script>
</body>
</html>