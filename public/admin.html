<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>予約管理画面 | LINE予約システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #333;
            font-size: 32px;
            font-weight: bold;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select, button {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 500;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .refresh-btn {
            background: #06c;
        }
        
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                flex-direction: column;
            }
            
            select, button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🗓️ 予約管理画面</h1>
            <div class="subtitle">
                <span id="storeName">レストラン</span> | 
                最終更新: <span id="lastUpdate">-</span>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">本日の予約</div>
                <div class="stat-value" id="todayCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">明日の予約</div>
                <div class="stat-value" id="tomorrowCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">今週の予約</div>
                <div class="stat-value" id="weekCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">全予約数</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="controls">
                <div class="filter-group">
                    <select id="dateFilter">
                        <option value="all">全期間</option>
                        <option value="today">今日</option>
                        <option value="tomorrow">明日</option>
                        <option value="week">今週</option>
                        <option value="month">今月</option>
                    </select>
                    <select id="statusFilter">
                        <option value="all">全ステータス</option>
                        <option value="pending">予約確定</option>
                        <option value="confirmed">確認済み</option>
                        <option value="cancelled">キャンセル</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button style="background: #667eea;" onclick="window.location.href='/admin-calendar'">
                        📅 カレンダー表示
                    </button>
                    <button class="refresh-btn" onclick="loadReservations()">
                        🔄 更新
                    </button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <div id="loading" class="loading" style="display:none;">
                    読み込み中...
                </div>
                <div id="error" class="error" style="display:none;"></div>
                <table id="reservationsTable" style="display:none;">
                    <thead>
                        <tr>
                            <th>予約ID</th>
                            <th>お名前</th>
                            <th>日付</th>
                            <th>時間</th>
                            <th>人数</th>
                            <th>メッセージ</th>
                            <th>ステータス</th>
                            <th>作成日時</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="reservationsBody">
                    </tbody>
                </table>
                <div id="noData" class="no-data" style="display:none;">
                    予約データがありません
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // グローバル変数：全予約データを保持
        let allReservations = [];
        
        // XSS対策: HTMLエスケープ関数
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '-';
            return String(unsafe)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;');
        }
        
        // 日付フォーマット関数（YYYY-MM-DD → 日本語表示）
        // @param {string} dateStr - ISO形式の日付文字列
        // @returns {string} ローカライズされた日付文字列
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ja-JP');  // 例: 2024/01/20
        }
        
        // 日時フォーマット関数（タイムスタンプ → 日本語表示）
        // @param {string} dateStr - ISO形式の日時文字列
        // @returns {string} ローカライズされた日時文字列
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('ja-JP');  // 例: 2024/01/20 15:30:00
        }
        
        // 時刻フォーマット関数（HH:MM:SS → HH:MM）
        // @param {string} timeStr - 時刻文字列（HH:MM:SS形式）
        // @returns {string} 時分のみの時刻文字列
        function formatTime(timeStr) {
            if (!timeStr) return '-';
            return timeStr.substring(0, 5);  // 秒を削除
        }
        
        // ステータスバッジHTML生成関数
        // @param {string} status - 予約ステータス（pending/confirmed/cancelled）
        // @returns {string} スタイル付きバッジのHTML
        function getStatusBadge(status) {
            const statusMap = {
                'pending': '<span class="status-badge status-pending">予約確定</span>',
                'confirmed': '<span class="status-badge status-confirmed">確認済み</span>',
                'cancelled': '<span class="status-badge status-cancelled">キャンセル</span>'
            };
            return statusMap[status] || status;  // 未定義ステータスはそのまま表示
        }
        
        // 統計情報カードの更新
        // @param {Array} reservations - 予約データの配列
        function updateStats(reservations) {
            // 日付範囲の計算
            const today = new Date().toISOString().split('T')[0];  // 今日
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];  // 明日（+1日）
            const weekEnd = new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0];  // 1週間後
            
            // 各期間の予約数カウント
            const todayCount = reservations.filter(r => r.date === today).length;
            const tomorrowCount = reservations.filter(r => r.date === tomorrow).length;
            const weekCount = reservations.filter(r => r.date >= today && r.date <= weekEnd).length;
            
            // DOM更新
            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('tomorrowCount').textContent = tomorrowCount;
            document.getElementById('weekCount').textContent = weekCount;
            document.getElementById('totalCount').textContent = reservations.length;
        }
        
        // 予約データのフィルタリング処理
        // 日付とステータスの両方でフィルタリング可能
        function filterReservations() {
            // フィルター条件取得
            const dateFilter = document.getElementById('dateFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            // 全データのコピーからスタート
            let filtered = [...allReservations];
            
            // 日付フィルター適用
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            const weekEnd = new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0];
            const monthEnd = new Date(Date.now() + 30 * 86400000).toISOString().split('T')[0];
            
            // 選択された期間に応じてフィルタリング
            switch(dateFilter) {
                case 'today':
                    filtered = filtered.filter(r => r.date === today);
                    break;
                case 'tomorrow':
                    filtered = filtered.filter(r => r.date === tomorrow);
                    break;
                case 'week':  // 今週（今日から7日間）
                    filtered = filtered.filter(r => r.date >= today && r.date <= weekEnd);
                    break;
                case 'month':  // 今月（今日から30日間）
                    filtered = filtered.filter(r => r.date >= today && r.date <= monthEnd);
                    break;
                // 'all'の場合はフィルタリングなし
            }
            
            // ステータスフィルター適用
            if (statusFilter !== 'all') {
                filtered = filtered.filter(r => r.status === statusFilter);
            }
            
            // フィルタリング結果を表示
            displayReservations(filtered);
        }
        
        // 予約データのテーブル表示
        // @param {Array} reservations - 表示する予約データの配列
        function displayReservations(reservations) {
            // DOM要素取得
            const tbody = document.getElementById('reservationsBody');
            const table = document.getElementById('reservationsTable');
            const noData = document.getElementById('noData');
            
            // 既存の行をクリア
            tbody.innerHTML = '';
            
            // データなしの場合の処理
            if (reservations.length === 0) {
                table.style.display = 'none';
                noData.style.display = 'block';
                return;
            }
            
            // データありの場合はテーブル表示
            table.style.display = 'table';
            noData.style.display = 'none';
            
            // 各予約データを行として追加
            reservations.forEach(reservation => {
                const row = tbody.insertRow();
                
                // XSS対策: 各セルを安全に作成
                const cells = [
                    escapeHtml(reservation.id),
                    escapeHtml(reservation.customer_name || 'ゲスト') + '様',
                    formatDate(reservation.date),
                    formatTime(reservation.time),
                    escapeHtml(reservation.people) + '名',
                    escapeHtml(reservation.message || '-'),
                    getStatusBadge(reservation.status), // HTMLバッジ（信頼できる）
                    formatDateTime(reservation.created_at)
                ];
                
                cells.forEach((content, index) => {
                    const cell = row.insertCell(index);
                    // ステータスバッジのみHTML許可
                    if (index === 6) {
                        cell.innerHTML = content;
                    } else {
                        cell.textContent = content;
                    }
                });
                
                // 操作列を追加（削除ボタン）
                const actionCell = row.insertCell(8);
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '🗑️ 削除';
                deleteBtn.style.cssText = 'padding: 5px 10px; background: #ef5350; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';
                deleteBtn.onclick = () => deleteReservation(reservation);
                actionCell.appendChild(deleteBtn);
            });
        }
        
        // 予約データ読み込み（API経由）
        async function loadReservations() {
            // UI要素取得
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const table = document.getElementById('reservationsTable');
            const noData = document.getElementById('noData');
            
            // ローディング表示
            loading.style.display = 'block';
            error.style.display = 'none';
            table.style.display = 'none';
            noData.style.display = 'none';
            
            try {
                // 環境に応じたAPIエンドポイントURL決定
                // ローカル開発: /api/admin-supabase
                // Vercel本番: https://xxx.vercel.app/api/admin-supabase
                const apiUrl = window.location.hostname === 'localhost' 
                    ? '/api/admin-supabase'
                    : `${window.location.origin}/api/admin-supabase`;
                const response = await fetch(apiUrl);
                
                // HTTPステータスチェック
                if (!response.ok) {
                    throw new Error('データの取得に失敗しました');
                }
                
                // JSONデータ取得
                const data = await response.json();
                allReservations = data.reservations || [];  // グローバル変数に保存
                
                // 日付・時刻で降順ソート（新しい予約が上）
                allReservations.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateB - dateA;  // 降順（新しい順）
                });
                
                // 統計更新・フィルター適用・表示
                updateStats(allReservations);
                filterReservations();
                
                // 最終更新時刻をヘッダーに表示
                document.getElementById('lastUpdate').textContent = 
                    new Date().toLocaleTimeString('ja-JP');  // 例: 15:30:45
                    
            } catch (err) {
                // エラー処理
                console.error('Error:', err);
                error.textContent = `エラー: ${err.message}`;
                error.style.display = 'block';
                noData.style.display = 'none';
            } finally {
                // ローディング非表示（成功・失敗どちらでも実行）
                loading.style.display = 'none';
            }
        }
        
        // 予約削除機能
        async function deleteReservation(reservation) {
            // 確認ダイアログ表示
            const confirmMessage = `予約ID: #${reservation.id}\n${reservation.customer_name || 'ゲスト'}様\n${reservation.date} ${reservation.time.substring(0, 5)}\n\nこの予約を削除しますか？`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // 削除APIを呼び出し
                const response = await fetch(`/api/admin-delete?id=${reservation.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('予約を削除しました');
                    // データ再読み込み
                    loadReservations();
                } else {
                    alert(`削除に失敗しました: ${result.error || '不明なエラー'}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('削除処理中にエラーが発生しました');
            }
        }
        
        // イベントリスナー登録
        document.getElementById('dateFilter').addEventListener('change', filterReservations);  // 日付フィルター変更時
        document.getElementById('statusFilter').addEventListener('change', filterReservations);  // ステータスフィルター変更時
        
        // 自動更新設定（30秒ごとにデータ再取得）
        setInterval(loadReservations, 30000);  // 30000ms = 30秒
        
        // ページ読み込み時の初回データ取得
        loadReservations();
    </script>
</body>
</html>