<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="0; url=/capacity-control-enhanced.html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リダイレクト中...</title>
    <script>
        window.location.href = '/capacity-control-enhanced.html';
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* ヘッダー */
        .header {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            color: #555;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #f8f9fa;
            border-color: #4a90e2;
            color: #4a90e2;
        }

        /* メインコンテナ */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* 設定パネル */
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* フォームグループ */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .required {
            color: #e74c3c;
        }

        input[type="date"],
        input[type="time"],
        input[type="number"],
        select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        /* 時間範囲スライダー */
        .time-range-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .time-range-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .time-display {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .time-slider {
            position: relative;
            height: 50px;
            background: linear-gradient(to right, #e8f4fd 0%, #4a90e2 0%, #4a90e2 100%, #e8f4fd 100%);
            border-radius: 25px;
            margin: 20px 0;
        }

        .slider-handle {
            position: absolute;
            width: 30px;
            height: 30px;
            background: white;
            border: 3px solid #4a90e2;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .slider-handle:active {
            cursor: grabbing;
        }

        .slider-handle.start {
            left: 30%;
        }

        .slider-handle.end {
            left: 70%;
        }

        .time-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            color: #666;
            font-size: 12px;
        }

        /* 制御タイプ選択 */
        .control-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-type {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .control-type:hover {
            border-color: #4a90e2;
            background: #f8f9fa;
        }

        .control-type.active {
            border-color: #4a90e2;
            background: #e8f4fd;
        }

        .control-type-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .control-type-label {
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
        }

        .control-type-desc {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* 時間入力フィールド */
        input[type="time"] {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            /* 24時間表記を強制 */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            position: relative;
            background: white;
        }
        
        /* Chrome/Safari用 - AM/PMを完全に非表示 */
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            display: none !important;
            visibility: hidden !important;
            width: 0 !important;
            height: 0 !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        input[type="time"]::-webkit-datetime-edit-text {
            padding: 0 2px;
        }
        
        input[type="time"]::-webkit-datetime-edit-hour-field {
            color: #333;
        }
        
        input[type="time"]::-webkit-datetime-edit-minute-field {
            color: #333;
        }
        
        input[type="time"]::-webkit-inner-spin-button {
            display: none;
        }
        
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: transparent;
            color: transparent;
            cursor: pointer;
            position: absolute;
            right: 0;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        
        /* Firefox用 */
        @-moz-document url-prefix() {
            input[type="time"] {
                -moz-appearance: textfield;
            }
        }
        
        /* Edge用 */
        input[type="time"]::-ms-clear {
            display: none;
        }

        /* 数値入力 */
        .limit-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .limit-input {
            width: 100px;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
        }

        .limit-unit {
            font-size: 16px;
            color: #555;
        }

        /* 追加オプション */
        .additional-options {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .option-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* アクションボタン */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        /* 登録済みカード一覧 */
        .saved-controls {
            margin-top: 40px;
        }

        .saved-controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .saved-controls-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
        }

        .filter-tab {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-tab.active {
            background: #4a90e2;
            color: white;
            border-color: #4a90e2;
        }

        /* カードグリッド */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .control-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
            position: relative;
        }

        .control-card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .card-date {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .card-time {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .card-limits {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .limit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .limit-item:last-child {
            margin-bottom: 0;
        }

        .limit-label {
            color: #666;
            font-size: 13px;
        }

        .limit-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .card-btn {
            flex: 1;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .card-btn:hover {
            background: #f8f9fa;
        }

        .card-btn.edit {
            color: #4a90e2;
            border-color: #4a90e2;
        }

        .card-btn.delete {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .card-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-upcoming {
            background: #fff3cd;
            color: #856404;
        }

        .status-past {
            background: #f8d7da;
            color: #721c24;
        }

        /* 空状態 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-subtext {
            font-size: 14px;
            color: #aaa;
        }

        /* モバイル対応 */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .control-type-selector {
                flex-direction: column;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* ローディング */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* トースト通知 */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.warning {
            border-left: 4px solid #f39c12;
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <div class="header">
        <div class="header-content">
            <h1>
                🎯 予約制御設定
                <span style="font-size: 14px; color: #666; font-weight: normal;">日付・時間帯・人数で細かく管理</span>
            </h1>
            <div class="nav-buttons">
                <a href="/admin" class="nav-btn">📋 管理画面</a>
                <a href="/admin-calendar" class="nav-btn">📅 カレンダー</a>
                <a href="/dashboard.html" class="nav-btn">📊 ダッシュボード</a>
            </div>
        </div>
    </div>

    <!-- メインコンテナ -->
    <div class="container">
        <!-- 新規設定パネル -->
        <div class="control-panel">
            <h2 class="panel-title">新規制御ルール作成</h2>

            <!-- 日付範囲選択 -->
            <div class="date-mode-selector">
                <label class="form-label">📅 適用期間の設定方法</label>
                <div class="control-type-selector">
                    <div class="control-type active" data-mode="single">
                        <div class="control-type-icon">📅</div>
                        <div class="control-type-label">単日指定</div>
                        <div class="control-type-desc">1つの日付のみ</div>
                    </div>
                    <div class="control-type" data-mode="range">
                        <div class="control-type-icon">📆</div>
                        <div class="control-type-label">期間指定</div>
                        <div class="control-type-desc">開始日から終了日まで</div>
                    </div>
                    <div class="control-type" data-mode="weekly">
                        <div class="control-type-icon">🗓️</div>
                        <div class="control-type-label">曜日指定</div>
                        <div class="control-type-desc">同じ曜日すべて</div>
                    </div>
                </div>
            </div>

            <!-- 日付と基本設定 -->
            <div class="form-row" id="dateInputsContainer">
                <!-- 単日指定 -->
                <div class="form-group" id="singleDateGroup">
                    <label class="form-label">
                        📅 対象日付 <span class="required">*</span>
                    </label>
                    <input type="date" id="targetDate" min="">
                </div>
                
                <!-- 期間指定 -->
                <div class="form-group" id="startDateGroup" style="display: none;">
                    <label class="form-label">
                        📅 開始日 <span class="required">*</span>
                    </label>
                    <input type="date" id="startDate" min="">
                </div>
                <div class="form-group" id="endDateGroup" style="display: none;">
                    <label class="form-label">
                        📅 終了日 <span class="required">*</span>
                    </label>
                    <input type="date" id="endDate" min="">
                </div>
                
                <!-- 曜日指定 -->
                <div class="form-group" id="weekdayGroup" style="display: none;">
                    <label class="form-label">
                        📅 対象曜日 <span class="required">*</span>
                    </label>
                    <select id="targetWeekday" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <option value="1">月曜日</option>
                        <option value="2">火曜日</option>
                        <option value="3">水曜日</option>
                        <option value="4">木曜日</option>
                        <option value="5">金曜日</option>
                        <option value="6">土曜日</option>
                        <option value="0">日曜日</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        🏷️ ルール名（任意）
                    </label>
                    <input type="text" id="ruleName" placeholder="例：GW期間ディナー制限">
                </div>
            </div>

            <!-- 時間範囲設定 -->
            <div class="time-range-container">
                <div class="time-range-header">
                    <span class="form-label">⏰ 対象時間帯</span>
                    <span class="time-display" id="timeDisplay">18:00 - 21:00</span>
                </div>
                
                <!-- 時間入力フィールド -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">開始時刻</label>
                        <input type="time" id="startTime" value="18:00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">終了時刻</label>
                        <input type="time" id="endTime" value="21:00">
                    </div>
                </div>
            </div>

            <!-- 制御タイプ選択 -->
            <label class="form-label" style="margin-bottom: 15px;">制御方法を選択</label>
            <div class="control-type-selector">
                <div class="control-type active" data-type="groups">
                    <div class="control-type-icon">👥</div>
                    <div class="control-type-label">組数で制限</div>
                    <div class="control-type-desc">◯組までと設定</div>
                </div>
                <div class="control-type" data-type="people">
                    <div class="control-type-icon">👤</div>
                    <div class="control-type-label">人数で制限</div>
                    <div class="control-type-desc">合計◯人までと設定</div>
                </div>
                <div class="control-type" data-type="both">
                    <div class="control-type-icon">⚡</div>
                    <div class="control-type-label">両方で制限</div>
                    <div class="control-type-desc">組数と人数両方</div>
                </div>
            </div>

            <!-- 数値設定 -->
            <div id="limitInputs">
                <div class="limit-input-group" id="groupsLimit">
                    <label class="form-label" style="margin: 0;">最大組数：</label>
                    <input type="number" class="limit-input" id="maxGroups" value="10" min="1">
                    <span class="limit-unit">組まで</span>
                </div>
                <div class="limit-input-group" id="peopleLimit" style="display: none;">
                    <label class="form-label" style="margin: 0;">最大人数：</label>
                    <input type="number" class="limit-input" id="maxPeople" value="40" min="1">
                    <span class="limit-unit">人まで</span>
                </div>
            </div>

            <!-- 追加オプション -->
            <div class="additional-options">
                <div class="option-item">
                    <input type="checkbox" class="option-checkbox" id="limitPerGroup">
                    <label for="limitPerGroup">1組あたりの最大人数を制限</label>
                    <input type="number" id="maxPerGroup" value="8" min="1" style="width: 60px; margin-left: 10px;" disabled>
                    <span class="limit-unit">人まで</span>
                </div>
            </div>

            <!-- アクションボタン -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveControl()">
                    💾 ルールを保存
                </button>
                <button class="btn btn-secondary" onclick="resetForm()">
                    🔄 リセット
                </button>
            </div>
        </div>

        <!-- 登録済みルール一覧 -->
        <div class="saved-controls">
            <div class="saved-controls-header">
                <h2 class="saved-controls-title">登録済みルール</h2>
                <div class="filter-tabs">
                    <div class="filter-tab active" data-filter="all">すべて</div>
                    <div class="filter-tab" data-filter="active">有効</div>
                    <div class="filter-tab" data-filter="upcoming">今後</div>
                    <div class="filter-tab" data-filter="past">過去</div>
                </div>
            </div>

            <div class="cards-grid" id="cardsGrid">
                <!-- カードが動的に追加される -->
            </div>

            <!-- 空状態 -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">📭</div>
                <div class="empty-text">まだルールが登録されていません</div>
                <div class="empty-subtext">上のフォームから新しいルールを作成してください</div>
            </div>
        </div>
    </div>

    <script>
        // 定数
        const STORE_ID = localStorage.getItem('store_id') || 'default-store';
        const API_BASE = '/api';
        
        // 状態管理
        let currentControlType = 'groups';
        let currentDateMode = 'single';
        let savedRules = [];
        
        // LocalStorageキー名を統一（デバッグしやすくする）
        const STORAGE_KEY = 'capacityRules';

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            initializeDatePicker();
            setupEventListeners();
            loadSavedRules();
            updateTimeDisplay();
            force24HourFormat();
        });

        // 日付ピッカーの初期化
        function initializeDatePicker() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            
            // 各日付入力フィールドの初期化
            const targetDate = document.getElementById('targetDate');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            // 最小日付を今日に設定
            [targetDate, startDate, endDate].forEach(input => {
                input.min = dateStr;
            });
            
            // 初期値設定
            targetDate.value = dateStr;
            startDate.value = dateStr;
            
            // 終了日を1週間後に設定
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            endDate.value = nextWeek.toISOString().split('T')[0];
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            // 日付モード選択
            document.querySelectorAll('[data-mode]').forEach(mode => {
                mode.addEventListener('click', () => {
                    // アクティブクラスの更新
                    document.querySelectorAll('[data-mode]').forEach(m => m.classList.remove('active'));
                    mode.classList.add('active');
                    
                    // 日付モードの更新
                    currentDateMode = mode.dataset.mode;
                    updateDateInputs();
                });
            });
            
            // 制御タイプ選択
            document.querySelectorAll('.control-type[data-type]').forEach(type => {
                type.addEventListener('click', () => {
                    document.querySelectorAll('.control-type[data-type]').forEach(t => t.classList.remove('active'));
                    type.classList.add('active');
                    currentControlType = type.dataset.type;
                    updateLimitInputs();
                });
            });

            // 時間変更監視
            document.getElementById('startTime').addEventListener('change', updateTimeDisplay);
            document.getElementById('endTime').addEventListener('change', updateTimeDisplay);

            // 1組あたり制限チェックボックス
            document.getElementById('limitPerGroup').addEventListener('change', (e) => {
                document.getElementById('maxPerGroup').disabled = !e.target.checked;
            });

            // フィルタータブ
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filterCards(tab.dataset.filter);
                });
            });
        }

        // 日付入力の表示切替
        function updateDateInputs() {
            const singleDateGroup = document.getElementById('singleDateGroup');
            const startDateGroup = document.getElementById('startDateGroup');
            const endDateGroup = document.getElementById('endDateGroup');
            const weekdayGroup = document.getElementById('weekdayGroup');
            
            // 全て非表示にする
            [singleDateGroup, startDateGroup, endDateGroup, weekdayGroup].forEach(group => {
                group.style.display = 'none';
            });
            
            // モードに応じて表示
            if (currentDateMode === 'single') {
                singleDateGroup.style.display = 'block';
            } else if (currentDateMode === 'range') {
                startDateGroup.style.display = 'block';
                endDateGroup.style.display = 'block';
            } else if (currentDateMode === 'weekly') {
                weekdayGroup.style.display = 'block';
            }
        }
        
        // 制限入力の表示切替
        function updateLimitInputs() {
            const groupsLimit = document.getElementById('groupsLimit');
            const peopleLimit = document.getElementById('peopleLimit');
            
            if (currentControlType === 'groups') {
                groupsLimit.style.display = 'flex';
                peopleLimit.style.display = 'none';
            } else if (currentControlType === 'people') {
                groupsLimit.style.display = 'none';
                peopleLimit.style.display = 'flex';
            } else if (currentControlType === 'both') {
                groupsLimit.style.display = 'flex';
                peopleLimit.style.display = 'flex';
            }
        }

        // 時間表示の更新
        function updateTimeDisplay() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            document.getElementById('timeDisplay').textContent = `${startTime} - ${endTime}`;
        }

        // 共通ユーティリティ：最初に見つかった値を返す
        function pickInputValue(selectors) {
            for (const sel of selectors) {
                const el = document.querySelector(sel);
                if (el && el.value != null) return String(el.value).trim();
            }
            return "";
        }

        // ルール保存
        async function saveControl() {
            // 日付データの取得
            let dateInfo = {};
            if (currentDateMode === 'single') {
                dateInfo.date = document.getElementById('targetDate').value;
                dateInfo.dateMode = 'single';
            } else if (currentDateMode === 'range') {
                dateInfo.startDate = document.getElementById('startDate').value;
                dateInfo.endDate = document.getElementById('endDate').value;
                dateInfo.dateMode = 'range';
            } else if (currentDateMode === 'weekly') {
                dateInfo.weekday = parseInt(document.getElementById('targetWeekday').value);
                dateInfo.dateMode = 'weekly';
            }
            
            // セレクタの揺れを許容
            const rawStart = pickInputValue([
                "#startTime","input[name='startTime']",
                "#ruleStartTime","input[name='ruleStartTime']",
                "[data-field='startTime']"
            ]);
            const rawEnd = pickInputValue([
                "#endTime","input[name='endTime']",
                "#ruleEndTime","input[name='ruleEndTime']",
                "[data-field='endTime']"
            ]);

            const isAllDay = currentDateMode === "allday";
            const ns = normalizeHHMMAny(rawStart);
            const ne = normalizeHHMMAny(rawEnd);

            if (!isAllDay && (!ns || !ne)) {
                alert(`開始/終了時刻を入力してください（HH:mm）\n取得: start='${rawStart}', end='${rawEnd}'`);
                return;
            }
            
            const finalStart = isAllDay ? "00:00" : ns;
            const finalEnd = isAllDay ? "23:59" : ne;
            
            const rule = {
                ...dateInfo,
                id: Date.now(), // Generate unique ID
                name: document.getElementById('ruleName').value || `${currentDateMode}制御ルール`,
                startTime: finalStart,
                endTime: finalEnd,
                controlType: currentControlType,
                maxGroups: currentControlType !== 'people' ? parseInt(document.getElementById('maxGroups').value) : null,
                maxPeople: currentControlType !== 'groups' ? parseInt(document.getElementById('maxPeople').value) : null,
                maxPerGroup: document.getElementById('limitPerGroup').checked ? parseInt(document.getElementById('maxPerGroup').value) : null,
                createdAt: new Date().toISOString(),
                schemaVersion: 2
            };

            try {
                // APIに保存を試行
                const response = await fetch(`${API_BASE}/capacity-control/rules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        store_id: STORE_ID,
                        ...rule
                    })
                });

                if (response.ok) {
                    // API保存成功
                    const savedRule = await response.json();
                    rule.id = savedRule.id;
                    showToast('ルールを保存しました', 'success');
                } else {
                    throw new Error('API保存失敗');
                }
            } catch (error) {
                console.error('API保存エラー:', error);
                // API失敗時はlocalStorageに保存
                console.log('LocalStorageに保存します');
                showToast('ルールをローカルに保存しました', 'warning');
            }
            
            // いずれの場合も画面に追加
            savedRules.push(rule);
            saveToLocalStorage();
            renderCards();
            resetForm();
        }

        // フォームリセット
        function resetForm() {
            document.getElementById('ruleName').value = '';
            document.getElementById('startTime').value = '18:00';
            document.getElementById('endTime').value = '21:00';
            document.getElementById('maxGroups').value = '10';
            document.getElementById('maxPeople').value = '40';
            document.getElementById('maxPerGroup').value = '8';
            document.getElementById('limitPerGroup').checked = false;
            // applyToWeekdaysは存在しないので削除
            document.getElementById('maxPerGroup').disabled = true;
            updateTimeDisplay();
        }

        // 保存済みルール読み込み
        async function loadSavedRules() {
            try {
                const response = await fetch(`${API_BASE}/capacity-control/rules?store_id=${STORE_ID}`);
                if (response.ok) {
                    savedRules = await response.json();
                } else {
                    throw new Error('API読み込み失敗');
                }
            } catch (error) {
                console.error('API読み込みエラー:', error);
                // API失敗時はlocalStorageから読み込み
                loadFromLocalStorage();
            }
            renderCards();
        }

        // LocalStorage保存
        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(savedRules));
            } catch (error) {
                console.error('LocalStorage保存エラー:', error);
            }
        }

        // LocalStorage読み込み（自動マイグレーション機能付き）
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const raw = JSON.parse(stored);
                    console.log('[Auto Migration] 既存データ数:', raw.length);
                    
                    // dateModeが未定義のルールを修正し、時刻データも正規化
                    const migrated = raw.map(rule => {
                        if (!rule.dateMode) {
                            if (rule.date) {
                                rule.dateMode = 'single';
                            } else if (rule.startDate && rule.endDate) {
                                rule.dateMode = 'range';
                            } else if (rule.weekday !== undefined && rule.weekday !== null) {
                                rule.dateMode = 'weekly';
                            } else {
                                rule.dateMode = 'single';
                            }
                        }
                        // ensureRuleShapeで時刻データを正規化（resolveTimes経由）
                        return ensureRuleShape(rule);
                    });
                    
                    // ★重要：正規化したデータを必ず保存し直す（idempotent: 重ねがけOK）
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
                    console.log('[Auto Migration] 正規化完了:', migrated.length, '件');
                    savedRules = migrated;
                    return migrated; // 配列を返す
                } else {
                    savedRules = [];
                    return [];
                }
            } catch (error) {
                console.error('LocalStorage読み込みエラー:', error);
                savedRules = [];
                return [];
            }
        }

        // カード表示（常に最新データを参照）
        function renderCards(rules) {
            const grid = document.getElementById('cardsGrid');
            const emptyState = document.getElementById('emptyState');
            
            // 引数がない場合は毎回LocalStorageから読み直す
            const src = Array.isArray(rules) ? rules : loadFromLocalStorage();
            const safe = Array.isArray(src) ? src.map(rule => ensureRuleShape(rule)) : [];
            
            // 整形済みデータを保存（任意）
            localStorage.setItem(STORAGE_KEY, JSON.stringify(safe));
            
            if (safe.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            // 最新の整形済みデータで描画
            grid.innerHTML = safe.map(rule => createRuleCard(rule)).join('');
        }

        // ルールカード作成
        function createRuleCard(rule) {
            // デバッグログ（詳細版）
            const shown = formatTimeRange(rule);
            console.debug("[createRuleCard] id:", rule?.id, {
                start: rule?.startTime, 
                end: rule?.endTime, 
                dateMode: rule?.dateMode,
                allDay: rule?.allDay,
                shown: shown || '(空文字)'
            });
            
            const today = new Date().toISOString().split('T')[0];
            
            // 日付表示とステータス判定を修正
            let dateDisplay = '';
            let status = 'upcoming';
            
            // dateMode が未定義の場合、既存のデータから推測
            if (!rule.dateMode) {
                if (rule.date) {
                    rule.dateMode = 'single';
                } else if (rule.startDate && rule.endDate) {
                    rule.dateMode = 'range';
                } else if (rule.weekday !== undefined && rule.weekday !== null) {
                    rule.dateMode = 'weekly';
                } else {
                    // デフォルト値を設定
                    rule.dateMode = 'single';
                    dateDisplay = '未設定';
                }
            }
            
            if (rule.dateMode === 'single' && rule.date) {
                dateDisplay = formatDate(rule.date);
                status = rule.date < today ? 'past' : rule.date === today ? 'active' : 'upcoming';
            } else if (rule.dateMode === 'range' && rule.startDate && rule.endDate) {
                dateDisplay = `${formatDate(rule.startDate)} - ${formatDate(rule.endDate)}`;
                status = rule.endDate < today ? 'past' : rule.startDate <= today && today <= rule.endDate ? 'active' : 'upcoming';
            } else if (rule.dateMode === 'weekly' && rule.weekday !== undefined && rule.weekday !== null) {
                const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
                dateDisplay = `毎週${weekdays[rule.weekday]}曜日`;
                status = 'active'; // 曜日指定は常にアクティブ
            }
            
            const statusText = status === 'past' ? '終了' : status === 'active' ? '有効' : '予定';
            const statusClass = `status-${status}`;
            
            return `
                <div class="control-card">
                    <div class="card-status ${statusClass}">${statusText}</div>
                    <div class="card-date">${dateDisplay}</div>
                    <div class="card-time">
                        ${(() => {
                            const { s, e, isAllDay } = resolveTimes(rule);
                            if (s && e) return `⏰ ${s} - ${e}`;
                            if (isAllDay) return "⏰ 終日";
                            return '<span style="opacity:.6">（時刻なし）</span>';
                        })()}
                    </div>
                    <div class="card-limits">
                        ${rule.maxGroups ? `<div class="limit-item">
                            <span class="limit-label">組数制限</span>
                            <span class="limit-value">${rule.maxGroups}組まで</span>
                        </div>` : ''}
                        ${rule.maxPeople ? `<div class="limit-item">
                            <span class="limit-label">人数制限</span>
                            <span class="limit-value">${rule.maxPeople}人まで</span>
                        </div>` : ''}
                        ${rule.maxPerGroup ? `<div class="limit-item">
                            <span class="limit-label">1組あたり</span>
                            <span class="limit-value">最大${rule.maxPerGroup}人</span>
                        </div>` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="card-btn edit" onclick="editRule('${rule.id}')">編集</button>
                        <button class="card-btn delete" onclick="deleteRule('${rule.id}')">削除</button>
                    </div>
                </div>
            `;
        }

        // 日付フォーマット
        function formatDate(dateStr) {
            if (!dateStr) return '未設定';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '未設定';
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            return `${date.getMonth() + 1}月${date.getDate()}日(${days[date.getDay()]})`;
        }

        // カードフィルタリング
        function filterCards(filter) {
            const today = new Date().toISOString().split('T')[0];
            let filtered = savedRules;
            
            if (filter === 'active') {
                filtered = savedRules.filter(r => r.date === today);
            } else if (filter === 'upcoming') {
                filtered = savedRules.filter(r => r.date > today);
            } else if (filter === 'past') {
                filtered = savedRules.filter(r => r.date < today);
            }
            
            // フィルタリング後の表示更新
            const grid = document.getElementById('cardsGrid');
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-text">該当するルールがありません</div></div>';
            } else {
                grid.innerHTML = filtered.map(rule => createRuleCard(rule)).join('');
            }
        }

        // ルール編集
        function editRule(id) {
            const rule = savedRules.find(r => r.id == id);
            if (!rule) return;
            
            // まず日付モードを設定
            currentDateMode = rule.dateMode || 'single';
            document.querySelectorAll('[data-mode]').forEach(m => m.classList.remove('active'));
            const modeElement = document.querySelector(`[data-mode="${currentDateMode}"]`);
            if (modeElement) {
                modeElement.classList.add('active');
            }
            updateDateInputs();
            
            // フォームに値を設定
            if (rule.dateMode === 'single' && rule.date) {
                document.getElementById('targetDate').value = rule.date;
            } else if (rule.dateMode === 'range') {
                document.getElementById('startDate').value = rule.startDate || '';
                document.getElementById('endDate').value = rule.endDate || '';
            } else if (rule.dateMode === 'weekly') {
                document.getElementById('targetWeekday').value = rule.weekday || 0;
            }
            
            document.getElementById('ruleName').value = rule.name || '';
            // 時刻を正規化して表示
            const normalizedStart = normalizeHHMM(rule.startTime) || '18:00';
            const normalizedEnd = normalizeHHMM(rule.endTime) || '21:00';
            document.getElementById('startTime').value = normalizedStart;
            document.getElementById('endTime').value = normalizedEnd;
            
            // 制御タイプを設定
            document.querySelectorAll('.control-type[data-type]').forEach(t => {
                if (t.classList) t.classList.remove('active');
            });
            const typeElement = document.querySelector(`.control-type[data-type="${rule.controlType}"]`);
            if (typeElement && typeElement.classList) {
                typeElement.classList.add('active');
            }
            currentControlType = rule.controlType || 'groups';
            updateLimitInputs();
            
            if (rule.maxGroups) document.getElementById('maxGroups').value = rule.maxGroups;
            if (rule.maxPeople) document.getElementById('maxPeople').value = rule.maxPeople;
            if (rule.maxPerGroup) {
                document.getElementById('limitPerGroup').checked = true;
                document.getElementById('maxPerGroup').disabled = false;
                document.getElementById('maxPerGroup').value = rule.maxPerGroup;
            }
            
            updateTimeDisplay();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ルール削除
        async function deleteRule(id) {
            if (!confirm('このルールを削除しますか？')) return;
            
            try {
                const response = await fetch(`${API_BASE}/capacity-control/rules/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // API削除成功
                    showToast('ルールを削除しました', 'success');
                } else {
                    // API削除失敗時もlocalStorageから削除
                    console.log('API削除失敗、LocalStorageから削除');
                    showToast('ルールをローカルから削除しました', 'warning');
                }
            } catch (error) {
                console.error('API削除エラー:', error);
                showToast('ルールをローカルから削除しました', 'warning');
            }
            
            // いずれの場合も画面から削除
            savedRules = savedRules.filter(r => r.id != id);
            saveToLocalStorage();
            renderCards();
        }

        // トースト通知
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                ${type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️'}
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 24時間表記強制関数
        function force24HourFormat() {
            const timeInputs = document.querySelectorAll('input[type="time"]');
            timeInputs.forEach(input => {
                // HTML属性で24時間表記を設定
                input.setAttribute('data-format', '24');
                input.step = '60'; // 1分刻み
                
                // イベントリスナーで値を24時間形式に変換
                input.addEventListener('change', function() {
                    const value = this.value;
                    if (value && !value.includes(':')) {
                        // 12時間形式の場合の変換処理
                        this.value = convertTo24Hour(value);
                    }
                });
                
                // フォーカス時にAM/PMピッカーを無効化
                input.addEventListener('focus', function() {
                    setTimeout(() => {
                        const ampmFields = document.querySelectorAll('[class*="ampm"], [class*="meridiem"]');
                        ampmFields.forEach(field => {
                            field.style.display = 'none';
                            field.style.visibility = 'hidden';
                        });
                    }, 10);
                });
            });
        }

        function convertTo24Hour(time12h) {
            if (!time12h || time12h.includes(':')) return time12h;
            
            const [time, modifier] = time12h.split(' ');
            let [hours, minutes] = time.split(':');
            
            if (hours === '12') {
                hours = '00';
            }
            
            if (modifier === 'PM' || modifier === 'pm') {
                hours = parseInt(hours, 10) + 12;
            }
            
            return `${hours}:${minutes}`;
        }

        // 時間正規化ヘルパー関数
        // 時刻の正規化関数（何が来てもHH:mm形式に変換）
        function normalizeHHMMAny(v) {
            if (v == null || v === "") return "";

            // 数値: 分単位 or 時のみ
            if (typeof v === "number" && Number.isFinite(v)) {
                if (v <= 24 && Number.isInteger(v)) return String(v).padStart(2, "0") + ":00"; // 9 → 09:00
                const h = Math.floor(v / 60), m = v % 60;                                     // 540 → 09:00
                return String(h).padStart(2, "0") + ":" + String(m).padStart(2, "0");
            }

            let s = String(v).trim();

            // 全角コロン/中点/ダッシュなどを吸収
            s = s.replace(/[：]/g, ":").replace(/[．。]/g, ".").replace(/[ｰー‐\-]/g, ":");

            // HH:mm / H:mm / HH.mm / H.mm
            let m = s.match(/^(\d{1,2})[:\.](\d{1,2})$/);
            if (m) {
                const h = Math.min(23, Math.max(0, +m[1]));
                const mm = Math.min(59, Math.max(0, +m[2]));
                return String(h).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
            }

            // 9時30分 / 9時 / 9時半
            m = s.match(/^(\d{1,2})時(?:(\d{1,2})分?)?$/);
            if (m) {
                const h = Math.min(23, Math.max(0, +m[1]));
                const mm = m[2] ? Math.min(59, Math.max(0, +m[2])) : 0;
                return String(h).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
            }
            m = s.match(/^(\d{1,2})時半$/);
            if (m) return String(+m[1]).padStart(2, "0") + ":30";

            // 0900 / 900 → 09:00
            if (/^\d{3,4}$/.test(s)) {
                const hm = s.padStart(4, "0");
                const h = +hm.slice(0, 2), mm = +hm.slice(2);
                if (h <= 23 && mm <= 59) return hm.slice(0, 2) + ":" + hm.slice(2);
            }

            // HH / H → HH:00
            if (/^\d{1,2}$/.test(s)) return s.padStart(2, "0") + ":00";

            // 既に HH:mm
            if (/^\d{2}:\d{2}$/.test(s)) return s;

            return "";
        }
        
        // 旧関数名を維持（互換性のため）
        function normalizeHHMM(v) {
            return normalizeHHMMAny(v);
        }

        // どのプロパティ名でも拾う時刻リゾルバ
        function pickTimeFrom(rule, keys) {
            for (const k of keys) {
                const v = k.split(".").reduce((o, p) => (o ? o[p] : undefined), rule);
                const t = normalizeHHMMAny(v);
                if (t) return t;
            }
            return "";
        }

        function resolveTimes(rule) {
            const startKeys = [
                "startTime","start","from","time.start","timeStart",
                "start_minutes","startMinute","startMin","start_time_minutes",
                "startAt","start_at","begin","beginTime"
            ];
            const endKeys = [
                "endTime","end","to","time.end","timeEnd",
                "end_minutes","endMinute","endMin","end_time_minutes",
                "endAt","end_at","finish","finishTime"
            ];
            const s = pickTimeFrom(rule, startKeys);
            const e = pickTimeFrom(rule, endKeys);
            const isAllDay = rule?.dateMode === "allday" || rule?.allDay === true;
            return { s, e, isAllDay };
        }
        
        // 旧関数を維持（互換性のため）
        function coalesceTime(...cands) {
            for (const c of cands) {
                const hhmm = normalizeHHMM(c);
                if (hhmm) return hhmm;
            }
            return "";
        }

        // 表示用関数を統一
        function formatTimeRange(rule) {
            const { s, e, isAllDay } = resolveTimes(rule);
            if (s && e) return `⏰ ${s} - ${e}`;
            if (isAllDay) return "⏰ 終日";
            return "";
        }

        // ルールの形状を保証する関数（resolveTimes使用）
        function ensureRuleShape(rule) {
            const r = { ...rule };
            const { s, e, isAllDay } = resolveTimes(r);
            
            if (s && e) { 
                r.startTime = s; 
                r.endTime = e; 
            } else if (isAllDay) { 
                r.startTime = "00:00"; 
                r.endTime = "23:59"; 
            } else { 
                r.startTime = s || ""; 
                r.endTime = e || ""; 
            }
            
            // 制御タイプが未定義の場合のみデフォルト値を設定
            if (!r.controlType) {
                r.controlType = 'groups';
            }

            // スキーマバージョン更新
            r.schemaVersion = 3;
            
            return r;
        }
    </script>
</body>
</html>