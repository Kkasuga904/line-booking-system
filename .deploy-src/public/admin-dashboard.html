<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    
    <!-- Dashboard Style -->
    <link rel="stylesheet" href="/css/dashboard-style.css">
    <!-- Sidebar Menu CSS -->
    <link rel="stylesheet" href="/css/sidebar-menu.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="page-header">
            <h1 class="page-title">äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        </div>

        <!-- æœŸé–“é¸æŠ -->
        <div class="period-selector">
            <span class="period-label">æœŸé–“é¸æŠï¼š</span>
            <select class="period-select" id="periodSelect">
                <option value="today">ä»Šæ—¥</option>
                <option value="week" selected>ä»Šé€±</option>
                <option value="month">ä»Šæœˆ</option>
                <option value="year">ä»Šå¹´</option>
            </select>
            <button class="btn-update" onclick="updateDashboard()">æ›´æ–°</button>
        </div>

        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">ç·äºˆç´„æ•°</div>
                        <div class="stat-value">342</div>
                        <div class="stat-change positive">â†‘ 12% å‰é€±æ¯”</div>
                    </div>
                    <div class="stat-icon">ğŸ“Š</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">å£²ä¸Šé«˜</div>
                        <div class="stat-value">Â¥1,248,000</div>
                        <div class="stat-change positive">â†‘ 8% å‰é€±æ¯”</div>
                    </div>
                    <div class="stat-icon">ğŸ’°</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">å¹³å‡å®¢å˜ä¾¡</div>
                        <div class="stat-value">Â¥3,648</div>
                        <div class="stat-change negative">â†“ 3% å‰é€±æ¯”</div>
                    </div>
                    <div class="stat-icon">ğŸ’³</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç‡</div>
                        <div class="stat-value">4.2%</div>
                        <div class="stat-change positive">â†‘ 1.5% æ”¹å–„</div>
                    </div>
                    <div class="stat-icon">âŒ</div>
                </div>
            </div>
        </div>

        <!-- æ—¥åˆ¥äºˆç´„æ•°æ¨ç§» -->
        <div class="chart-card">
            <h2 class="chart-header">æ—¥åˆ¥äºˆç´„æ•°æ¨ç§»</h2>
            <div class="chart-container">
                <canvas id="bookingChart"></canvas>
            </div>
        </div>

        <!-- æ™‚é–“å¸¯åˆ¥äºˆç´„åˆ†å¸ƒ -->
        <div class="chart-card">
            <h2 class="chart-header">æ™‚é–“å¸¯åˆ¥äºˆç´„åˆ†å¸ƒ</h2>
            <div class="chart-container">
                <canvas id="timeDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Sidebar Menu JS -->
    <script src='/js/sidebar-menu.js' defer></script>
    
    <script>
        // åº—èˆ—IDã‚’å–å¾—ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        function getStoreId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('store_id') || 'default-store';
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        async function updateDashboard() {
            const period = document.getElementById('periodSelect').value;
            const storeId = getStoreId();
            
            console.log('Updating dashboard for store:', storeId, 'period:', period);
            
            try {
                // APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await fetch(`/api/dashboard-stats?store_id=${storeId}&period=${period}`);
                const data = await response.json();
                
                if (data.success) {
                    // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
                    updateStatCards(data.stats);
                    // ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
                    updateCharts(data.charts);
                } else {
                    console.error('Failed to fetch dashboard data:', data.error);
                }
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
        function updateStatCards(stats) {
            // ç·äºˆç´„æ•°
            const bookingCard = document.querySelector('.stat-card:nth-child(1)');
            if (bookingCard && stats.totalBookings) {
                bookingCard.querySelector('.stat-value').textContent = stats.totalBookings.value;
                const changeEl = bookingCard.querySelector('.stat-change');
                changeEl.textContent = `${stats.totalBookings.change >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(stats.totalBookings.change)}% å‰é€±æ¯”`;
                changeEl.className = `stat-change ${stats.totalBookings.changeType}`;
            }

            // å£²ä¸Šé«˜
            const revenueCard = document.querySelector('.stat-card:nth-child(2)');
            if (revenueCard && stats.totalRevenue) {
                revenueCard.querySelector('.stat-value').textContent = stats.totalRevenue.formatted;
                const changeEl = revenueCard.querySelector('.stat-change');
                changeEl.textContent = `${stats.totalRevenue.change >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(stats.totalRevenue.change)}% å‰é€±æ¯”`;
                changeEl.className = `stat-change ${stats.totalRevenue.changeType}`;
            }

            // å¹³å‡å®¢å˜ä¾¡
            const avgCard = document.querySelector('.stat-card:nth-child(3)');
            if (avgCard && stats.avgOrderValue) {
                avgCard.querySelector('.stat-value').textContent = stats.avgOrderValue.formatted;
                const changeEl = avgCard.querySelector('.stat-change');
                changeEl.textContent = `${stats.avgOrderValue.change >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(stats.avgOrderValue.change)}% å‰é€±æ¯”`;
                changeEl.className = `stat-change ${stats.avgOrderValue.changeType}`;
            }

            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç‡
            const cancelCard = document.querySelector('.stat-card:nth-child(4)');
            if (cancelCard && stats.cancelRate) {
                cancelCard.querySelector('.stat-value').textContent = `${stats.cancelRate.value}%`;
                const changeEl = cancelCard.querySelector('.stat-change');
                changeEl.textContent = `${stats.cancelRate.change >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(stats.cancelRate.change)}% æ”¹å–„`;
                changeEl.className = `stat-change ${stats.cancelRate.changeType}`;
            }
        }

        // ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
        let bookingChart = null;
        let timeDistributionChart = null;

        // ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        function updateCharts(chartData) {
            if (chartData && chartData.daily) {
                updateBookingChart(chartData.daily);
            }
            if (chartData && chartData.hourly) {
                updateTimeDistributionChart(chartData.hourly);
            }
        }

        // æ—¥åˆ¥äºˆç´„æ•°ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        function updateBookingChart(data) {
            const ctx = document.getElementById('bookingChart').getContext('2d');
            
            if (bookingChart) {
                // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
                bookingChart.data.labels = data.labels;
                bookingChart.data.datasets[0].data = data.data;
                bookingChart.update();
            } else {
                // æ–°ã—ã„ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
                bookingChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'äºˆç´„æ•°',
                            data: data.data,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    borderDash: [2, 2]
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }

        // æ™‚é–“å¸¯åˆ¥åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        function updateTimeDistributionChart(data) {
            const ctx = document.getElementById('timeDistributionChart').getContext('2d');
            
            if (timeDistributionChart) {
                // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
                timeDistributionChart.data.labels = data.labels;
                timeDistributionChart.data.datasets[0].data = data.data;
                timeDistributionChart.update();
            } else {
                // æ–°ã—ã„ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
                timeDistributionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'äºˆç´„æ•°',
                            data: data.data,
                            backgroundColor: '#764ba2',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    borderDash: [2, 2]
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }

        // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ï¼‰
        function loadCharts() {
            // æ—¥åˆ¥äºˆç´„æ•°æ¨ç§»
            const ctx1 = document.getElementById('bookingChart').getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'],
                    datasets: [{
                        label: 'äºˆç´„æ•°',
                        data: [45, 52, 48, 65, 68, 72, 58],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                borderDash: [2, 2]
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // æ™‚é–“å¸¯åˆ¥äºˆç´„åˆ†å¸ƒ
            const ctx2 = document.getElementById('timeDistributionChart').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00'],
                    datasets: [{
                        label: 'äºˆç´„æ•°',
                        data: [8, 12, 25, 18, 15, 20, 28, 35, 42, 38, 25, 15],
                        backgroundColor: '#764ba2',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                borderDash: [2, 2]
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Dashboard] Initializing dashboard...');
            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆæœŸåŒ–ã‚’ç¢ºèª
            setTimeout(() => {
                if (!document.querySelector('.sidebar-container')) {
                    console.error('[Dashboard] Sidebar not found, reloading sidebar-menu.js');
                    const script = document.createElement('script');
                    script.src = '/js/sidebar-menu.js';
                    document.body.appendChild(script);
                }
            }, 100);
            // åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            updateDashboard();
        });
    </script>
</body>
</html>